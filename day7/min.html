<body id=b>

<script>C={unit:"in",camX:0,camY:0,camZ:0,camRX:0,camRY:0,camRZ:0,plane_count:0,cube_count:0,options:{},$:r=>document.getElementById(r),init:r=>{r.css||(r.css=""),r.html||(r.html=""),r.g||(r.g="scene"),r.o||(r.o="center"),"bottom"==r.o&&(r.y-=r.h/2),r.w||(r.w=0),r.h||(r.h=0),r.x||(r.x=0),r.y||(r.y=0),r.z||(r.z=0),r.rx||(r.rx=0),r.ry||(r.ry=0),r.rz||(r.rz=0),r.sx||(r.sx=1),r.sy||(r.sy=1),r.sz||(r.sz=1),C.options[r.n]=r},group:r=>{r.d||0===r.d||(r.d=r.h),C.init(r),C.$(r.g).innerHTML+=`<div id="${r.n}"class="group ${r.css}"style="position:absolute;width:${r.w}${C.unit};height:${r.d}${C.unit};transform:${C.tr(r)}">`},plane:r=>{r.n||(r.n=`plane${C.plane_count++}`),C.init(r),C.$(r.g).innerHTML+=`<div id="${r.n}"class="plane ${r.css}"style="position:absolute;width:${r.w}${C.unit};height:${r.h}${C.unit};background:${r.b};transform-origin:${r.o};transform:${C.tr(r)}">${r.html}`,C.camera()},cube:r=>{r.n||(r.n=`cube${C.cube_count++}`),C.init(r),C.group(r),C.plane({g:r.n,x:r.w/2,y:r.d/2,w:r.w,h:r.d,b:r.b,css:"bottom"}),C.plane({g:r.n,y:r.d/2,w:r.d,h:r.h,b:r.b,rx:-90,ry:-90,o:"bottom",css:"left"}),C.plane({g:r.n,x:r.w,y:r.d/2,w:r.d,h:r.h,b:r.b3,rx:-90,ry:-90,o:"bottom",css:"right"}),C.plane({g:r.n,x:r.w/2,y:0,w:r.w,h:r.h,b:r.b2,rx:-90,o:"bottom",css:"back"}),C.plane({g:r.n,x:r.w/2,y:r.d,w:r.w,h:r.h,b:r.b2,rx:-90,o:"bottom",css:"front"}),C.plane({g:r.n,x:r.w/2,y:r.d/2,z:r.h,w:r.w,h:r.d,b:r.b,css:"top"})},camera:r=>{r&&(r.x||0===r.x)&&(C.camX=r.x),r&&(r.y||0===r.y)&&(C.camY=r.y),r&&(r.z||0===r.z)&&(C.camZ=r.z),r&&(r.rx||0===r.rx)&&(C.camRX=r.rx),r&&(r.ry||0===r.ry)&&(C.camRY=r.ry),r&&(r.rz||0===r.rz)&&(C.camRZ=r.rz),C.camX+=(Math.random()-.5)/1e3,scene.style.transformOrigin=`${C.camX}${C.unit} ${C.camY}${C.unit}`,scene.style.transform=`translateX(${-C.camX}${C.unit})translateY(${-C.camY}${C.unit})translateZ(${-C.camZ}${C.unit})rotateX(${C.camRX}deg)rotateY(${C.camRY}deg)rotateZ(${C.camRZ}deg)`},move:r=>{if(r.n){var i=C.$(r.n),e=C.options[r.n];(r.x||0===r.x)&&(e.x=r.x),(r.y||0===r.y)&&(e.y=r.y),(r.z||0===r.z)&&(e.z=r.z),(r.rx||0===r.rx)&&(e.rx=r.rx),(r.ry||0===r.ry)&&(e.ry=r.ry),(r.rz||0===r.rz)&&(e.rz=r.rz),C.options[r.n]=e,i.style.transform=C.tr(e)}},tr:r=>`${"top left"==r.o?"":"translateX(-50%)translateY(-50%)"}translateX(${r.x}${C.unit})translateY(${r.y}${C.unit})translateZ(${r.z}${C.unit})rotateX(${r.rx}deg)rotateY(${r.ry}deg)rotateZ(${r.rz}deg)`};var mode=2,world=0,puzzle=0,race=0,cx=25,cy=25,cz=30,crx=70,cry=0,crz=0,carx=210,cary=330,carrz=0,carspeed=0,front=[0,0,0],back=[0,0,0],frontcell=[0,0],backcell=[0,0],oob=0,collision=0,speedduringcollision=0,fcell,bcell,fcellinfo,bcellinfo,space=[],roads=[],roadlinks=[],toRadians=r=>r*(Math.PI/180),dist2=(r,i)=>(r[0]-i[0])**2+(r[1]-i[1])**2,delog=()=>deb.innerHTML="",log=(...r)=>deb.innerHTML+=r+"\n",barriers=r=>{var[i,e,a]=r;if(0==a){var o=space[i][e][a];o.barriers={u:0,r:0,d:0,l:0},o.u+o.r+o.d+o.l>0&&(o.u||o.d?o.l||o.r?o.u&&o.l&&!o.r&&!o.d?(o.barriers.r=1,o.barriers.d=1):o.u&&!o.l&&o.r&&!o.d?(o.barriers.l=1,o.barriers.d=1):!o.u&&o.l&&!o.r&&o.d&&(o.barriers.r=1,o.barriers.u=1):(o.barriers.l=1,o.barriers.r=1):(o.barriers.u=1,o.barriers.d=1),!o.u&&!o.l&&o.r&&o.d?(o.barriers.u=1,o.barriers.l=1):o.u+o.r+o.d+o.l==3&&(o.u||(o.barriers.u=1),o.r||(o.barriers.r=1),o.d||(o.barriers.d=1),o.l||(o.barriers.l=1))),o.barriers.u&&(C.$(`road-${i}-${e}-${a}`).style.borderTop=".5in solid #000"),o.barriers.d&&(C.$(`road-${i}-${e}-${a}`).style.borderBottom=".5in solid #000"),o.barriers.l&&(C.$(`road-${i}-${e}-${a}`).style.borderLeft=".5in solid #000"),o.barriers.r&&(C.$(`road-${i}-${e}-${a}`).style.borderRight=".5in solid #000")}},links=()=>{for(i of roadlinks)i[0][0]==i[1][0]&&i[0][2]==i[1][2]&&i[0][1]==i[1][1]-1&&(C.plane({w:20,h:1,x:20*i[0][0],y:20*i[0][1]+19.5,z:.2,b:"#d90",o:"top left",css:"barrierleftright"}),space[i[0][0]][i[0][1]][i[0][2]].d=1,space[i[1][0]][i[1][1]][i[1][2]].u=1),i[0][0]==i[1][0]&&i[0][2]==i[1][2]&&i[0][1]==i[1][1]+1&&(C.plane({w:20,h:1,x:20*i[1][0],y:20*i[1][1]+19.5,z:.2,b:"#d90",o:"top left",css:"barrierleftright"}),space[i[0][0]][i[0][1]][i[0][2]].u=1,space[i[1][0]][i[1][1]][i[1][2]].d=1),i[0][0]==i[1][0]-1&&i[0][2]==i[1][2]&&i[0][1]==i[1][1]&&(C.plane({w:1,h:20,x:20*i[0][0]+19.5,y:20*i[1][1],z:.2,b:"#d90",o:"top left",css:"barriertopbottom"}),space[i[0][0]][i[0][1]][i[0][2]].r=1,space[i[1][0]][i[1][1]][i[1][2]].l=1),i[0][0]==i[1][0]+1&&i[0][2]==i[1][2]&&i[0][1]==i[1][1]&&(C.plane({w:1,h:20,x:20*i[1][0]+19.5,y:20*i[1][1],z:.2,b:"#d90",o:"top left",css:"barriertopbottom"}),space[i[0][0]][i[0][1]][i[0][2]].l=1,space[i[1][0]][i[1][1]][i[1][2]].r=1)},turns=()=>{for(i of roads){[x,y,z]=i;var r=space[x][y][z];r.flat={u:1,r:1,d:1,l:1},r.u&&r.r&&!r.d&&!r.l?(C.$(`road-${x}-${y}-${z}`).style.borderRadius="0 0 0 100%",r.flat.d=0,r.flat.l=0):!r.u&&r.r&&r.d&&!r.l?(C.$(`road-${x}-${y}-${z}`).style.borderRadius="100% 0 0 0",r.flat.u=0,r.flat.l=0):!r.u&&!r.r&&r.d&&r.l?(C.$(`road-${x}-${y}-${z}`).style.borderRadius="0 100% 0 0",r.flat.u=0,r.flat.r=0):r.u&&!r.r&&!r.d&&r.l&&(C.$(`road-${x}-${y}-${z}`).style.borderRadius="0 0 100% 0",r.flat.d=0,r.flat.r=0)}},equations=()=>{for(i of roads){[x,y,z]=i;var r=space[x][y][z];r.u&&r.r&&!r.d&&!r.l?r.equation=`dist2([x,y],[${20*x+20},${20*y}])>19**2`:!r.u&&r.r&&r.d&&!r.l?r.equation=`dist2([x,y],[${20*x+20},${20*y+20}])>19*19`:!r.u&&!r.r&&r.d&&r.l?r.equation=`dist2([x,y],[${20*x},${20*y+20}])>19*19`:r.u&&!r.r&&!r.d&&r.l?r.equation=`dist2([x,y],[${20*x},${20*y}])>19*19`:r.equation="false"}},init=()=>{if(b.innerHTML="<textarea id=deb rows=6 cols=99></textarea><div id=viewport><div id=camera><div id=scene>",2==mode){for(i=0;i<20;i++)for(space[i]=[],j=0;j<20;j++)space[i][j]=[];for(i of(C.camera({x:cx,y:cy,z:cz,rx:crx}),C.group({n:"car",w:0,h:0,rz:90}),C.cube({g:"car",b:"#a33",b2:"#922",b3:"#c44",w:4,d:2,h:.75,z:.4}),C.cube({g:"car",b:"#a33",b2:"#922",b3:"#c44",w:2,d:2,h:.55,z:1.15}),C.plane({g:"car",b:"#555",w:.8,h:.8,rx:90,x:1,y:1.1,z:.58,css:"circle"}),C.plane({g:"car",b:"#555",w:.8,h:.8,rx:90,x:1,y:-1.1,z:.58,css:"circle"}),C.plane({g:"car",b:"#555",w:.8,h:.8,rx:90,x:-1,y:1.1,z:.58,css:"circle"}),C.plane({g:"car",b:"#555",w:.8,h:.8,rx:90,x:-1,y:-1.1,z:.58,css:"circle"}),C.plane({g:"car",b:"#555",w:.3,h:.78,rx:90,ry:90,x:1,y:.95,z:.58}),C.plane({g:"car",b:"#555",w:.3,h:.78,rx:90,ry:90,x:1,y:-.95,z:.58}),C.plane({g:"car",b:"#555",w:.3,h:.78,rx:90,ry:90,x:-1,y:.95,z:.58}),C.plane({g:"car",b:"#555",w:.3,h:.78,rx:90,ry:90,x:-1,y:-.95,z:.58}),roads=[[10,16,0],[10,15,0],[10,14,0],[10,13,0],[9,13,0],[8,13,0],[8,12,0],[7,12,0],[7,11,0],[6,11,0],[6,10,0],[7,10,0],[8,10,0],[9,10,0],[10,10,0],[11,10,0],[11,9,0],[11,11,0],[12,10,0],[14,10,0],[15,10,0],[16,10,0],[16,11,0],[15,11,0],[15,12,0],[15,13,0],[15,14,0],[14,14,0],[13,14,0],[12,14,0],[11,14,0]]))space[i[0]][i[1]][i[2]]={type:0,u:0,r:0,d:0,l:0,barriers:{u:0,r:0,d:0,l:0}},C.plane({n:`road-${i[0]}-${i[1]}-${i[2]}`,x:20*i[0],y:20*i[1],z:.2,w:20,h:20,b:"#d90",o:"top left",css:"block0 z0"});for(roadlinks=[[[11,10,0],[11,11,0]],[[11,10,0],[12,10,0]],[[15,10,0],[15,11,0]],[[11,14,0],[10,14,0]]],i=1;i<roads.length-1;i++)roadlinks.push([roads[i],roads[i+1]]);for(i of(links(),roadlinks))barriers(i[0]),barriers(i[1]);turns(),equations()}};init();var u=0,l=0,d=0,r=0;onkeydown=onkeyup=(r=>top["lld*rlurdu"[r.which%32%17]]=r.type[5]);var testcollision=(f,fcell,fcellinfo)=>{[x,y,z]=fcell;try{fcellinfo=space[x][y][z]}catch(r){}if(fcellinfo)if(fcellinfo.u+fcellinfo.r+fcellinfo.d+fcellinfo.l==0)log("nolink"),oob=0;else if(("false"!=fcellinfo.equation&&!oob||"false"==fcellinfo.equation&&oob)&&(log("noeq"),oob=0),fcellinfo.barriers.u&&fcellinfo.flat.u&&f[1]%20<1)log("u"),collision=1;else if(fcellinfo.barriers.r&&fcellinfo.flat.r&&f[0]%20>19)log("r"),collision=1,speedduringcollision=carspeed;else if(fcellinfo.barriers.d&&fcellinfo.flat.d&&f[1]%20>19)log("d"),collision=1,speedduringcollision=carspeed;else if(fcellinfo.barriers.l&&fcellinfo.flat.l&&f[0]%20<1)log("l"),collision=1,speedduringcollision=carspeed;else if("false"==fcellinfo.equation||oob){if("false"!=fcellinfo.equation&&oob){log("oob & eq"),[x,y,z]=f;var ev=eval(fcellinfo.equation);0==ev&&(collision=1,speedduringcollision=carspeed)}}else{log("inbounds & eq"),[x,y,z]=f;var ev=eval(fcellinfo.equation);1==ev&&(collision=1,speedduringcollision=carspeed)}else log("noinfo"),oob=1};setInterval(()=>{if(2==mode){for(var i=0;i<5;i++){delog(),log("oob",oob),u?(carspeed+=.002)>(oob?.2:.4)&&(carspeed=oob?.2:.4):d?(carspeed-=.0015)<(oob?-.15:-.3)&&(carspeed=oob?-.15:-.3):carspeed*=.99,l&&u||r&&d?carrz-=.7:(r&&u||l&&d)&&(carrz+=.7),carx+=carspeed*Math.sin(toRadians(carrz)),cary-=carspeed*Math.cos(toRadians(carrz));var e=[carx+2*Math.sin(toRadians(carrz)),cary-2*Math.cos(toRadians(carrz)),0],a=[carx+-2*Math.sin(toRadians(carrz)),cary- -2*Math.cos(toRadians(carrz)),0];fcell=[~~(e[0]/20),~~(e[1]/20),0],bcell=[~~(a[0]/20),~~(a[1]/20),0],carspeed>=0?testcollision(e,fcell,fcellinfo):testcollision(a,bcell,bcellinfo),frontcell=fcell,backcell=bcell}collision&&(carspeed=speedduringcollision>=0?-.05:.05,(collision-=.1)<=0&&(collision=0))}C.camera({x:carx,y:cary,rz:-carrz}),C.move({n:"car",x:carx,y:cary,rz:carrz+90})},33)
C.plane({x:10*20+10,y:16*20+15,z:10,w:19,h:5,rx:-90,b:"#abf",o:"center",html:"start"});
C.plane({x:10*20,y:16*20+15.1,z:6.25,w:1,h:12.5,rx:-90,b:"#000",o:"center"});
C.plane({x:10*20+19.5,y:16*20+15.1,z:6.25,w:1,h:12.5,rx:-90,b:"#000",o:"center"})
</script>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:calibri}
#viewport{width:100vw;height:100vh;background:#fff;overflow:hidden;position:relative;perspective:8in}
#viewport *{transform-style:preserve-3d;box-sizing:border-box}
#camera{width:0;height:0;position:absolute;top:90%;left:50%}
x#scene{transition:1s linear}
x.group{transition:.1s linear}
.circle{border-radius:50%}
#deb{position:fixed;top:0;left:0;z-index:2;xtop:-999px;font-size:10px}
.plane{text-align:center;font-size:4in;}
.block0.z0{border:.5in solid #ddd}
.barrierleftright{border-left:.5in solid #000;border-right:.5in solid #000}
.barriertopbottom{border-top:.5in solid #000;border-bottom:.5in solid #000}