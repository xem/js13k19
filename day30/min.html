<meta name="monetization" content="$pay.stronghold.co/1a1fbf27169a5334158b2c531b946427ceb">
<div id=b>

<script src=css3d.js>C={unit:"px",camX:0,camY:0,camZ:0,camRX:0,camRY:0,camRZ:0,el:0,sprite_count:0,sprites:[],plane_count:0,cube_count:0,options:{},$:e=>document.getElementById(e),init:e=>{e.css||(e.css=""),e.html||(e.html=""),e.g||(e.g="scene"),e.o||(e.o="center"),"bottom"==e.o&&(e.y-=e.h/2),e.w||(e.w=0),e.h||(e.h=0),e.x||(e.x=0),e.y||(e.y=0),e.z||(e.z=0),e.rx||(e.rx=0),e.ry||(e.ry=0),e.rz||(e.rz=0),e.el||(e.el=0),e.sx||(e.sx=1),e.sy||(e.sy=1),e.sz||(e.sz=1),C.options[e.n]=e},group:e=>{e.d||0===e.d||(e.d=e.h),C.init(e),C.$(e.g).innerHTML+=`<div id="${e.n}"class="group ${e.css}"style="position:absolute;width:${e.w}${C.unit};height:${e.d}${C.unit};background:${e.b};transform:${C.tr(e)}">`},plane:e=>{e.n||(e.n=`plane${C.plane_count++}`),C.init(e),C.$(e.g).innerHTML+=`<div id="${e.n}"class="plane ${e.css}"style="position:absolute;width:${e.w}${C.unit};height:${e.h}${C.unit};background:${e.b};background-position:${e.bp};transform-origin:${e.o};transform:${C.tr(e)}">${e.html}`,C.camera()},sprite:e=>{e.n||(e.n=`sprite${C.sprite_count++}`),C.init(e),C.$(e.g).innerHTML+=`<div id="${e.n}"class="sprite ${e.css}"style="position:absolute;width:${e.w}${C.unit};height:${e.h}${C.unit};background:${e.b};transform-origin:${e.o};transform:${C.tr(e)}">${e.html}`,C.sprites.push(e.n),C.camera()},cube:e=>{e.n||(e.n=`cube${C.cube_count++}`),C.init(e),C.group(e),C.plane({g:e.n,x:e.w/2,y:e.d/2,w:e.w,h:e.d,b:e.b,css:"bottom"}),C.plane({g:e.n,y:e.d/2,w:e.d,h:e.h,b:e.b,rx:-90,ry:-90,o:"bottom",css:"left"}),C.plane({g:e.n,x:e.w,y:e.d/2,w:e.d,h:e.h,b:e.b3,rx:-90,ry:-90,o:"bottom",css:"right"}),C.plane({g:e.n,x:e.w/2,y:0,w:e.w,h:e.h,b:e.b2,rx:-90,o:"bottom",css:"back"}),C.plane({g:e.n,x:e.w/2,y:e.d,w:e.w,h:e.h,b:e.b2,rx:-90,o:"bottom",css:"front"}),C.plane({g:e.n,x:e.w/2,y:e.d/2,z:e.h,w:e.w,h:e.d,b:e.b,css:"top"})},camera:e=>{if(e&&(e.x||0===e.x)&&(C.camX=e.x),e&&(e.y||0===e.y)&&(C.camY=e.y),e&&(e.z||0===e.z)&&(C.camZ=e.z),e&&(e.rx||0===e.rx)&&(C.camRX=e.rx),e&&(e.ry||0===e.ry)&&(C.camRY=e.ry),e&&(e.rz||0===e.rz)&&(C.camRZ=e.rz),e&&(e.el||0===e.el)&&(C.el=e.el),C.camX+=(Math.random()-.5)/1e3,top.scene)for(var r in scene.style.transformOrigin=`${C.camX}${C.unit} ${C.camY}${C.unit} ${C.camZ-C.el}${C.unit}`,scene.style.transform=`translateX(${-C.camX}${C.unit})translateY(${-C.camY}${C.unit})translateZ(${-C.camZ}${C.unit})rotateX(${C.camRX}deg)rotateY(${C.camRY}deg)rotateZ(${C.camRZ}deg)translateZ(${-C.el}${C.unit})`,C.sprites){var i=C.$(C.sprites[r]);if(i){var s=i.style.transform.replace(/ *rotate.*\(.*?deg\)/g,"");i.style.transform=s+`rotateZ(${-C.camRZ}deg)rotateX(${-C.camRX}deg)`}}},move:e=>{if(e.n){var r=C.$(e.n);if(r){var i=C.options[e.n];(e.x||0===e.x)&&(i.x=e.x),(e.y||0===e.y)&&(i.y=e.y),(e.z||0===e.z)&&(i.z=e.z),(e.rx||0===e.rx)&&(i.rx=e.rx),(e.ry||0===e.ry)&&(i.ry=e.ry),(e.rz||0===e.rz)&&(i.rz=e.rz),C.options[e.n]=i,r.style.transform=C.tr(i)}}},tr:e=>`${"top left"==e.o?"":"translateX(-50%)translateY(-50%)"}translateX(${e.x}${C.unit})translateY(${e.y}${C.unit})translateZ(${e.z}${C.unit})rotateX(${e.rx}deg)rotateY(${e.ry}deg)rotateZ(${e.rz}deg)`},levels={editor:{roads:[],roadlinks:[],inventory:[[1,1,1],[2,1,1],[0,99,99],[3,99,99],[4,99,99],[5,99,99],[6,99,99],[7,99,99],[8,99,99],[9,99,99],[10,99,99],[12,99,99],[13,99,99]]},title:{roads:[[3,3,0,0,0,0],[3,4,0,0,0,0],[3,5,0,0,0,0],[4,4,0,0,0,0],[5,4,0,0,0,0],[5,5,0,0,0,0],[4,5,0,0,0,0],[4,3,0,0,0,0],[6,4,0,0,0,0],[6,3,0,0,0,0],[7,3,0,0,0,0],[7,4,0,0,0,0],[7,5,0,0,0,0],[10,5,0,0,0,0],[9,5,0,0,0,0],[8,5,0,0,0,0],[8,4,0,0,0,0],[8,3,0,0,0,0],[9,3,0,0,0,0],[10,4,0,0,0,0],[11,4,0,0,0,0],[11,5,0,0,0,0],[12,5,0,0,0,0],[11,3,0,0,0,0],[12,3,0,0,0,0],[5,7,0,0,0,0],[5,8,0,0,0,0],[6,8,0,0,0,0],[7,7,0,0,0,0],[7,8,0,0,0,0],[8,7,0,0,0,0],[8,8,0,0,0,0],[6,7,0,0,0,0],[4,10,0,0,0,0],[6,12,0,0,0,0],[6,11,0,0,0,0],[6,10,0,0,0,0],[7,10,0,0,0,0],[9,10,0,0,0,0],[9,11,0,0,0,0],[9,12,0,0,0,0],[8,12,0,0,0,0],[8,11,0,0,0,0],[11,10,0,0,0,0],[10,10,0,0,0,0],[10,11,0,0,0,0],[10,12,0,0,0,0],[11,12,0,0,0,0],[12,12,0,0,0,0],[12,11,0,0,0,0],[12,10,0,0,0,0],[13,11,0,0,0,0],[13,10,0,0,0,0],[13,12,0,0,0,0],[14,12,0,0,0,0],[12,9,0,2,0,0],[6,5,0,1,0,0],[10,2,0,0,0,0],[10,8,0,12,0,0],[3,7,0,12,0,0],[2,12,0,12,0,0],[14,2,0,12,0,0],[14,14,0,12,0,0],[14,10,0,0,0,0],[4,11,0,8,0,0],[4,12,0,8,0,0],[5,10,0,0,0,0],[8,10,0,4,270,0],[3,10,0,3,90,0],[10,3,0,3,180,0]],roadlinks:[[[3,3,0],[3,4,0]],[[3,4,0],[3,5,0]],[[3,4,0],[4,4,0]],[[4,4,0],[5,4,0]],[[5,4,0],[5,5,0]],[[5,5,0],[4,5,0]],[[4,5,0],[3,5,0]],[[4,3,0],[4,4,0]],[[4,3,0],[3,3,0]],[[6,4,0],[6,3,0]],[[6,3,0],[7,3,0]],[[7,3,0],[7,4,0]],[[7,4,0],[7,5,0]],[[7,4,0],[6,4,0]],[[9,5,0],[8,5,0]],[[8,5,0],[8,4,0]],[[8,4,0],[8,3,0]],[[8,3,0],[9,3,0]],[[10,4,0],[10,5,0]],[[10,4,0],[11,4,0]],[[11,4,0],[11,5,0]],[[11,5,0],[12,5,0]],[[11,4,0],[11,3,0]],[[11,3,0],[12,3,0]],[[5,7,0],[5,8,0]],[[5,8,0],[6,8,0]],[[7,7,0],[7,8,0]],[[7,7,0],[8,7,0]],[[8,7,0],[8,8,0]],[[6,8,0],[6,7,0]],[[6,7,0],[5,7,0]],[[6,12,0],[6,11,0]],[[6,11,0],[6,10,0]],[[6,10,0],[7,10,0]],[[9,10,0],[9,11,0]],[[9,11,0],[9,12,0]],[[9,12,0],[8,12,0]],[[8,12,0],[8,11,0]],[[8,11,0],[9,11,0]],[[11,10,0],[10,10,0]],[[10,10,0],[10,11,0]],[[10,11,0],[10,12,0]],[[10,12,0],[11,12,0]],[[12,12,0],[12,11,0]],[[12,11,0],[12,10,0]],[[12,11,0],[13,11,0]],[[13,11,0],[13,10,0]],[[13,10,0],[13,11,0]],[[13,11,0],[13,12,0]],[[13,12,0],[14,12,0]],[[12,9,0],[12,10,0]],[[6,5,0],[6,4,0]],[[13,10,0],[14,10,0]],[[4,11,0],[4,10,0]],[[4,12,0],[4,11,0]],[[5,10,0],[4,10,0]],[[8,10,0],[9,10,0]],[[3,10,0],[4,10,0]],[[10,3,0],[10,2,0]],[[10,3,0],[10,4,0]]],inventory:[]},A1:{n:"A1",roads:[[6,13,0,1,0],[10,6,0,2,0]],roadlinks:[],inventory:[[0,20,20]],gold:5,silver:10,bronze:15,ice:[[8,8,3,3]]},B1:{n:"B1",roads:[[10,13,2,1,0,0],[10,12,2,0,0,0],[10,7,2,0,0,0],[10,6,2,2,0,0]],roadlinks:[[[10,12,2],[10,13,2]],[[10,6,2],[10,7,2]]],inventory:[[5,4,4]]}},window.b=b,window.s=window.u=window.l=window.d=window.r=0,window.S=window.U=window.L=window.D=window.R=0,window._=window.$=0;var mode=0,world=0,puzzle=0,race=0,size=100,sizeh=50,cx=0,cy=0,cz=0,crx=82,cry=0,crz=0,carx=10*size+size/2,cary=16*size+size/2,carrz=0,carrzd=0,carspeed=0,caracc=0,front=[0,0,0],back=[0,0,0],frontcell=[0,0],backcell=[0,0],oob=0,collision=0,speedduringcollision=0,fcell,bcell,fcellinfo,bcellinfo,space=[],roads=[],roadlinks=[],ice=[],vspeed=0,gridz=0,gridrz=0,gridrzreal=0,cursorx=0,cursory=0,cursorrz=0,cursorrzreal=0,selected=0,rerender=0,inventory=[],track={},originaltrack={},ev,timer=0,speeder=0,carangledisplay=0,air=0,acc=0,start=[],end=[],checkpoints=0,onice=0,i,j,k,x,y,z,block,times,audiocontexts=[],intervals=[],timeout=0;onload=onhashchange=(()=>{location.hash&&(mode=2,init(JSON.parse(atob(location.hash.slice(1)))),location.hash="")});var a=(notes,center,duration,decaystart,decayduration,interval,volume,waveform,i)=>{var A,G,i,O;with(A=new AudioContext)with(G=createGain())for(i of notes)with(O=createOscillator())connect(G),G.connect(destination),start(i[0]*interval),frequency.setValueAtTime(center*1.06**(13-i[1]),i[0]*interval),type=waveform,gain.setValueAtTime(volume,i[0]*interval),gain.setTargetAtTime(1e-5,i[0]*interval+decaystart,decayduration),stop(i[0]*interval+duration);audiocontexts.push(A)},play=(e,r,i,s)=>{for(var l of audiocontexts)l.close();for(l of(audiocontexts=[],intervals))clearInterval(l);for(l of(intervals=[],timeout&&clearTimeout(timeout),timeout=setTimeout(()=>{for(l of r)a(...l);intervals.push(setInterval(()=>{for(l of r)a(...l);console.log("1")},s))},i),console.log("0"),e))a(...l)},musics={menu:[[[[[0,17],[1,5],[2,17],[3,5],[4,14],[5,2],[6,13],[7,1],[8,12],[9,0],[10,2],[11,4],[12,5],[13,7],[14,9],[15,10],[16,17],[17,5],[18,17],[19,5],[20,14],[21,2],[22,13],[23,1],[24,12],[25,0],[26,2],[27,4],[28,5],[29,7],[30,9],[31,10]],55,.19,.15,.005,.22,.6,"triangle"],[[[0,24],[1,0],[2,0],[3,24],[4,24],[6,0],[7,24],[8,24],[10,0],[11,24],[12,24],[14,0],[15,24],[16,24],[17,0],[18,0],[19,24],[20,24],[28,24],[24,24],[22,0],[23,24],[26,0],[27,24],[31,24],[30,0]],880,.19,.17,.005,.22,.01,"sawtooth"]]],editor:[[[[[0,3],[1,6],[2,8],[3,11]],440,.25,.18,.005,.26,.1,""],[[[0,15],[2,13]],220,.25,.18,.005,.26,.05,""]],[[[[0,13],[2,15],[4,15],[5,13],[6,11],[7,3],[8,6],[10,8],[32,13],[34,15],[38,13],[39,11],[40,13],[42,15],[31,11],[30,8],[29,6],[28,3],[60,3],[61,6],[62,8],[63,11]],440,.25,.18,.005,.26,.1,""],[[[0,8],[0,13],[0,15],[8,6],[8,11],[8,13],[16,8],[16,13],[16,15],[24,6],[24,11],[24,13],[32,8],[32,13],[32,15],[40,6],[40,11],[40,13],[48,8],[48,13],[48,15],[56,6],[56,11],[56,13]],220,2,1,1,.26,.05,"triangle"],[[[0,8],[4,11],[6,13],[12,13],[14,11],[20,11],[22,13],[28,13],[30,11],[36,11],[38,13],[44,13],[46,11],[52,11],[54,13],[60,15],[62,13]],220,.25,.18,.005,.26,.05,""],[[[14,3],[30,15],[46,3],[50,8]],880,1.5,.2,1.3,.26,.05,""]]],race:[[[[[0,16],[1,16],[6,18],[3,18],[5,18],[8,20],[9,20],[11,21],[13,21],[14,21],[21,23],[22,23],[24,20],[25,20],[27,21],[29,21],[30,21],[23,23],[16,23],[17,23],[18,23],[19,23],[20,23],[32,16],[33,16],[35,18],[37,18],[38,18],[40,20],[41,20],[43,21],[45,21],[46,21],[48,23],[49,23],[50,23],[51,23],[52,23],[53,23],[54,23],[55,23],[56,20],[57,20],[59,21],[61,21],[62,21],[31,18],[63,18],[65,16],[64,16],[67,18],[69,18],[70,18],[72,20],[73,20],[75,21],[77,21],[78,21],[80,23],[81,23],[82,23],[83,23],[84,23],[85,23],[86,23],[87,23],[88,20],[89,20],[91,21],[93,21],[94,21],[95,18],[96,16],[97,16],[99,18],[101,18],[102,18],[104,20],[105,20],[107,21],[109,21],[110,21],[112,23],[113,23],[114,23],[115,23],[116,23],[117,23],[118,23],[119,23],[120,20],[121,20],[123,21],[125,21],[126,21],[127,18],[128,16],[129,16],[136,18],[137,18],[144,23],[145,23],[152,20],[153,20],[155,21],[157,21],[158,21],[160,16],[161,16],[168,18],[169,18],[176,23],[181,23],[190,21],[135,17],[167,17],[177,23],[180,23],[184,20],[185,20],[187,21],[189,21]],220,.19,.18,.005,.2,.05,""],[[[0,16],[0,9],[1,9],[1,16],[3,18],[3,11],[5,18],[6,18],[5,11],[6,11],[8,20],[8,13],[9,13],[9,20],[11,21],[11,14],[13,21],[14,21],[13,14],[14,14],[16,23],[17,23],[19,23],[21,23],[22,23],[23,23],[20,23],[18,23],[24,20],[25,20],[24,13],[25,13],[27,21],[27,14],[29,21],[30,21],[29,14],[30,14],[32,9],[33,9],[32,16],[33,16],[35,11],[37,11],[38,11],[35,18],[37,18],[38,18],[40,20],[41,20],[40,13],[41,13],[43,14],[45,14],[46,14],[43,21],[45,21],[46,21],[48,23],[49,23],[51,23],[52,23],[53,23],[54,23],[55,23],[50,23],[56,20],[57,20],[56,13],[57,13],[59,21],[59,14],[61,14],[62,14],[61,21],[62,21],[128,16],[129,16],[128,9],[129,9],[136,18],[137,18],[136,11],[137,11],[144,23],[145,23],[153,20],[153,13],[158,14],[158,21],[160,9],[161,9],[160,16],[161,16],[168,11],[169,11],[168,18],[169,18],[176,23],[181,23],[16,16],[18,16],[19,16],[21,16],[22,16],[23,16],[20,16],[17,16],[48,16],[49,16],[50,16],[52,16],[53,16],[54,16],[55,16],[51,16],[145,16],[144,16],[176,16],[159,21],[159,14],[156,14],[156,21],[154,20],[154,13],[181,16],[185,20],[190,21],[185,13],[190,14],[177,16],[177,23],[186,13],[186,20],[188,21],[191,21],[191,14],[188,14],[180,16],[180,23]],440,.19,.18,.005,.2,.05,"sawtooth"],[[[64,16],[65,16],[64,9],[65,9],[67,18],[69,18],[70,18],[67,11],[69,11],[70,11],[72,20],[73,20],[72,13],[73,13],[75,21],[75,14],[77,14],[78,14],[77,21],[78,21],[80,23],[81,23],[82,23],[83,23],[84,23],[85,23],[86,23],[87,23],[80,16],[82,16],[85,16],[86,16],[87,16],[84,16],[83,16],[81,16],[88,13],[89,13],[88,20],[89,20],[91,14],[93,14],[94,14],[91,21],[93,21],[94,21],[96,9],[96,16],[101,11],[101,18],[104,20],[104,13],[109,14],[109,21],[97,9],[97,16],[99,11],[102,11],[99,18],[102,18],[105,13],[105,20],[107,21],[107,14],[110,14],[110,21],[112,23],[113,23],[114,23],[115,23],[116,23],[117,23],[118,23],[119,23],[112,16],[113,16],[114,16],[115,16],[116,16],[117,16],[118,16],[119,16],[120,13],[121,13],[120,20],[121,20],[123,21],[125,21],[126,21],[123,14],[125,14],[126,14]],440,.19,.18,.005,.2,.06,"sawtooth"],[[[64,18],[65,16],[66,13],[72,18],[73,16],[74,13],[80,18],[81,16],[82,13],[88,18],[89,16],[90,13],[91,16],[92,11],[93,10],[94,11],[95,13],[96,18],[97,16],[98,13],[104,18],[105,16],[106,13],[112,18],[113,16],[114,13],[120,18],[121,16],[122,13],[123,16],[124,11],[125,10],[126,11]],440,.19,.18,.005,.2,.05,"square"],[[[67,16],[75,16],[83,16],[99,16],[107,16],[115,16],[127,16]],440,1.5,.5,1,.2,.05,"square"]]]},toRadians=e=>e*(Math.PI/180),dist2=(e,r)=>(e[0]-r[0])**2+(e[1]-r[1])**2,delog=()=>deb.innerHTML="",log=(...e)=>deb.innerHTML+=e+"\n",barriers=e=>{if([x,y,z]=e,0==z&&(block=space[x][y][z])){for(var r="u",i="r",s="d",l="l",a=0;a<block.angle;a+=90)[r,i,s,l]=[i,s,l,r];0==block.id?(C.$(`road-${x}-${y}-${z}`).children[0].style.border="0",block.barriers={u:0,r:0,d:0,l:0},(block.links.u||block.links.r||block.links.d||block.links.l)&&(block.links[r]||block.links[s]?block.links[l]||block.links[i]?block.links[r]&&block.links[l]&&!block.links[i]&&!block.links[s]?(block.barriers[i]=1,block.barriers[s]=1):block.links[r]&&!block.links[l]&&block.links[i]&&!block.links[s]?(block.barriers[l]=1,block.barriers[s]=1):!block.links[r]&&block.links[l]&&!block.links[i]&&block.links[s]&&(block.barriers[i]=1,block.barriers[r]=1):(block.barriers[l]=1,block.barriers[i]=1):(block.barriers[r]=1,block.barriers[s]=1),!block.links[r]&&!block.links[l]&&block.links[i]&&block.links[s]?(block.barriers[r]=1,block.barriers[l]=1):block.links[r]&&block.links[i]&&block.links[s]&&!block.links[l]?block.barriers[l]=1:block.links[r]&&block.links[i]&&!block.links[s]&&block.links[l]?block.barriers[s]=1:block.links[r]&&!block.links[i]&&block.links[s]&&block.links[l]?block.barriers[i]=1:!block.links[r]&&block.links[i]&&block.links[s]&&block.links[l]&&(block.barriers[r]=1))):1==block.id?(C.$(`road-${x}-${y}-${z}`).children[0].style.border="0",block.barriers={u:1,r:1,d:1,l:1},0==block.angle&&block.links.u&&(block.barriers.u=0),90==block.angle&&block.links.r&&(block.barriers.r=0),180==block.angle&&block.links.d&&(block.barriers.d=0),270==block.angle&&block.links.l&&(block.barriers.l=0)):2==block.id?(C.$(`road-${x}-${y}-${z}`).children[0].style.border="0",block.barriers={u:1,r:1,d:1,l:1},0==block.angle&&block.links.d&&(block.barriers.d=0),90==block.angle&&block.links.l&&(block.barriers.l=0),180==block.angle&&block.links.u&&(block.barriers.u=0),270==block.angle&&block.links.r&&(block.barriers.r=0)):3==block.id?(C.$(`road-${x}-${y}-${z}`).children[0].style.border="0",block.barriers={u:1,r:1,d:1,l:1},block.links.u&&(block.barriers.u=0),block.links.d&&(block.barriers.d=0),block.links.r&&(block.barriers.r=0),block.links.l&&(block.barriers.l=0)):4==block.id?(C.$(`road-${x}-${y}-${z}`).children[0].style.border="0",block.barriers={u:0,r:0,d:0,l:0},0!=block.angle||block.links.d||(block.barriers.d=1),90!=block.angle||block.links.l||(block.barriers.l=1),180!=block.angle||block.links.u||(block.barriers.u=1),270!=block.angle||block.links.r||(block.barriers.r=1)):5==block.id?(C.$(`road-${x}-${y}-${z}`).children[0].style.border="0",block.barriers={u:0,r:0,d:0,l:0},0!=block.angle||block.links.d||(block.barriers.d=1),90!=block.angle||block.links.l||(block.barriers.l=1),180!=block.angle||block.links.u||(block.barriers.u=1),270!=block.angle||block.links.r||(block.barriers.r=1)):6==block.id?(C.$(`road-${x}-${y}-${z}`).children[0].style.border="0",block.barriers={u:0,r:0,d:0,l:0},0!=block.angle||block.links.d||(block.barriers.d=1),90!=block.angle||block.links.l||(block.barriers.l=1),180!=block.angle||block.links.u||(block.barriers.u=1),270!=block.angle||block.links.r||(block.barriers.r=1)):7==block.id?(C.$(`road-${x}-${y}-${z}`).children[0].style.border="0",block.barriers={u:0,r:0,d:0,l:0},0!=block.angle||block.links.d||(block.barriers.d=1),90!=block.angle||block.links.l||(block.barriers.l=1),180!=block.angle||block.links.u||(block.barriers.u=1),270!=block.angle||block.links.r||(block.barriers.r=1)):8==block.id?(C.$(`road-${x}-${y}-${z}`).children[0].style.border="0",block.barriers={u:1,r:1,d:1,l:1},block.links.u&&(block.barriers.u=0),block.links.d&&(block.barriers.d=0),block.links.r&&(block.barriers.r=0),block.links.l&&(block.barriers.l=0)):9!=block.id&&10!=block.id||(C.$(`road-${x}-${y}-${z}`).children[0].style.border="0",block.barriers={u:0,r:0,d:0,l:0},0!=block.angle||block.links.d||(block.barriers.d=1),90!=block.angle||block.links.l||(block.barriers.l=1),180!=block.angle||block.links.u||(block.barriers.u=1),270!=block.angle||block.links.r||(block.barriers.r=1)),block.barriers[r]&&(C.$(`road-${x}-${y}-${z}`).children[0].style.borderTop="5px solid #000"),block.barriers[s]&&(C.$(`road-${x}-${y}-${z}`).children[0].style.borderBottom="5px solid #000"),block.barriers[l]&&(C.$(`road-${x}-${y}-${z}`).children[0].style.borderLeft="5px solid #000"),block.barriers[i]&&(C.$(`road-${x}-${y}-${z}`).children[0].style.borderRight="5px solid #000")}},links=()=>{for(j of document.querySelectorAll(".barrierleftright,.barriertopbottom"))j.remove();for(i of roadlinks)if(i[0]){var e=space[i[0][0]][i[0][1]][i[0][2]],r=space[i[1][0]][i[1][1]][i[1][2]];i[0][0]==i[1][0]&&i[0][1]<i[1][1]&&(e.slope||r.slope?e.slope&&!r.slope?C.plane({n:1,w:.8*size,h:.1*size,x:i[1][0]*size+.1*size,y:i[1][1]*size+1*size-size,z:sizeh*i[1][2]+1,b:"#d90",o:"top left",css:`barrierleftright ${0==i[1][2]?"z0":""}`}):!e.slope&&r.slope&&C.plane({n:2,w:.8*size,h:.1*size,x:i[0][0]*size+.1*size,y:i[0][1]*size+.9*size,z:sizeh*i[0][2]+1,b:"#d90",o:"top left",css:`barrierleftright ${0==i[0][2]?"z0":""}`}):C.plane({n:"zer0",w:.8*size,h:.2*size,x:i[0][0]*size+.1*size,y:i[0][1]*size+.9*size,z:sizeh*i[0][2]+1,b:"#d90",o:"top left",css:`barrierleftright ${0==i[0][2]?"z0":""}`}),e.links.d=[i[1][0],i[1][1],i[1][2]],r.links.u=[i[0][0],i[0][1],i[0][2]]),i[0][0]==i[1][0]&&i[0][1]>i[1][1]&&(e.slope||r.slope?e.slope&&!r.slope?C.plane({n:11,w:.8*size,h:.1*size,x:i[1][0]*size+.1*size,y:i[1][1]*size+.9*size,z:sizeh*i[1][2]+1,b:"#d90",o:"top left",css:`barrierleftright ${0==i[1][2]?"z0":""}`}):!e.slope&&r.slope&&C.plane({n:12,w:.8*size,h:.1*size,x:i[1][0]*size+.1*size,y:i[1][1]*size+size,z:sizeh*i[1][2]+1,b:"#d90",o:"top left",css:`barrierleftright ${0==i[1][2]?"z0":""}`}):C.plane({n:10,w:.8*size,h:.2*size,x:i[1][0]*size+.1*size,y:i[1][1]*size+.9*size,z:sizeh*i[1][2]+1,b:"#d90",o:"top left",css:`barrierleftright ${0==i[1][2]?"z0":""}`}),e.links.u=[i[1][0],i[1][1],i[1][2]],r.links.d=[i[0][0],i[0][1],i[0][2]]),i[0][0]<i[1][0]&&i[0][1]==i[1][1]&&(e.slope||r.slope?e.slope&&!r.slope?C.plane({n:21,w:.1*size,h:.8*size,x:i[1][0]*size,y:i[1][1]*size+.1*size,z:sizeh*i[1][2]+1,b:"#d90",o:"top left",css:`barriertopbottom ${0==i[1][2]?"z0":""}`}):!e.slope&&r.slope&&C.plane({n:22,w:.1*size,h:.8*size,x:i[0][0]*size+.9*size,y:i[0][1]*size+.1*size,z:sizeh*i[0][2]+1,b:"#d90",o:"top left",css:`barriertopbottom ${0==i[0][2]?"z0":""}`}):C.plane({n:20,w:.2*size,h:.8*size,x:i[0][0]*size+.9*size,y:i[1][1]*size+.1*size,z:sizeh*i[0][2]+1,b:"#d90",o:"top left",css:`barriertopbottom ${0==i[0][2]?"z0":""}`}),e.links.r=[i[1][0],i[1][1],i[1][2]],r.links.l=[i[0][0],i[0][1],i[0][2]]),i[0][0]>i[1][0]&&i[0][1]==i[1][1]&&(e.slope||r.slope?e.slope&&!r.slope?C.plane({n:31,w:.1*size,h:.8*size,x:i[1][0]*size+.9*size,y:i[1][1]*size+.1*size,z:sizeh*i[1][2]+1,b:"#d90",o:"top left",css:`barriertopbottom ${0==i[1][2]?"z0":""}`}):!e.slope&&r.slope&&C.plane({n:32,w:.1*size,h:.8*size,x:i[0][0]*size,y:i[0][1]*size+.1*size,z:sizeh*i[0][2]+1,b:"#d90",o:"top left",css:`barriertopbottom ${0==i[0][2]?"z0":""}`}):C.plane({n:30,w:.2*size,h:.8*size,x:i[1][0]*size+.9*size,y:i[1][1]*size+.1*size,z:sizeh*i[1][2]+1,b:"#d90",o:"top left",css:`barriertopbottom ${0==i[1][2]?"z0":""}`}),e.links.l=[i[1][0],i[1][1],i[1][2]],r.links.r=[i[0][0],i[0][1],i[0][2]])}},turns=()=>{for(i of roads)i&&([x,y,z]=i,(block=space[x][y][z])&&0==block.id&&(block.flat={u:1,r:1,d:1,l:1},block.links.u&&block.links.r&&!block.links.d&&!block.links.l?(C.$(`road-${x}-${y}-${z}`).children[0].style.borderRadius="0 0 0 100%",block.flat.d=0,block.flat.l=0):!block.links.u&&block.links.r&&block.links.d&&!block.links.l?(C.$(`road-${x}-${y}-${z}`).children[0].style.borderRadius="100% 0 0 0",block.flat.u=0,block.flat.l=0):!block.links.u&&!block.links.r&&block.links.d&&block.links.l?(C.$(`road-${x}-${y}-${z}`).children[0].style.borderRadius="0 100% 0 0",block.flat.u=0,block.flat.r=0):block.links.u&&!block.links.r&&!block.links.d&&block.links.l?(C.$(`road-${x}-${y}-${z}`).children[0].style.borderRadius="0 0 100% 0",block.flat.d=0,block.flat.r=0):C.$(`road-${x}-${y}-${z}`)&&(C.$(`road-${x}-${y}-${z}`).children[0].style.borderRadius="0",block.flat={u:1,r:1,d:1,l:1})))},equations=()=>{for(i of roads)i&&([x,y,z]=i,(block=space[x][y][z])&&(0==block.id?block.links.u&&block.links.r&&!block.links.d&&!block.links.l?(block.inbounds=`dist2([carx,cary],[${x*size+size},${y*size}])<80**2`,block.fall=`dist2([carx,cary],[${x*size+size},${y*size}])<80**2?${z*sizeh}:0`):!block.links.u&&block.links.r&&block.links.d&&!block.links.l?(block.inbounds=`dist2([carx,cary],[${x*size+size},${y*size+size}])<80**2`,block.fall=`dist2([carx,cary],[${x*size+size},${y*size+size}])<80**2?${z*sizeh}:0`):!block.links.u&&!block.links.r&&block.links.d&&block.links.l?(block.inbounds=`dist2([carx,cary],[${x*size},${y*size+size}])<80**2`,block.fall=`dist2([carx,cary],[${x*size},${y*size+size}])<80**2?${z*sizeh}:0`):block.links.u&&!block.links.r&&!block.links.d&&block.links.l?(block.inbounds=`dist2([carx,cary],[${x*size},${y*size}])<80**2`,block.fall=`dist2([carx,cary],[${x*size},${y*size}])<80**2?${z*sizeh}:0`):block.inbounds="true":1==block.id||2==block.id||3==block.id||block.id))},testcollision=()=>{var x,y,z,cellinfo,ev;[x,y,z]=[~~(carx/size),~~(cary/size),~~(carz/sizeh)];try{cellinfo=space[x][y][z]}catch(e){}if(onice=0,cellinfo)air?(ev=+eval(cellinfo.fall),carz>ev&&(air=1,vspeed+=.01,carz-=vspeed,carz<ev&&(carz=ev,vspeed=0,air=0,oob=0),carz<0&&(carz=0,vspeed=0,air=0))):(carz<10&&cellinfo.barriers.u&&cellinfo.flat.u&&cary%size<20?(collision=1,speedduringcollision=carspeed):carz<10&&cellinfo.barriers.r&&cellinfo.flat.r&&carx%size>80?(collision=1,speedduringcollision=carspeed):carz<10&&cellinfo.barriers.d&&cellinfo.flat.d&&cary%size>80?(collision=1,speedduringcollision=carspeed):carz<10&&cellinfo.barriers.l&&cellinfo.flat.l&&carx%size<20?(collision=1,speedduringcollision=carspeed):oob=0,3==cellinfo.id&&0==cellinfo.passed&&(cellinfo.passed=1,checkpoints--,console.log(checkpoints)),2==cellinfo.id&&(0==cellinfo.angle&&cary%size<50||90==cellinfo.angle&&carx%size>50||180==cellinfo.angle&&cary%size>50||270==cellinfo.angle&&carx%size<50)&&0==checkpoints&&(console.log("end"),mode=3,init(track),play(musics.menu[0],musics.menu[0],7100,7100)),8==cellinfo.id||10==cellinfo.id?0==cellinfo.angle?carrz>270||carrz<90?(carspeed+=.01,acc=1):(carspeed-=.01,acc=1):90==cellinfo.angle?carrz>0&&carrz<180?(carspeed+=.01,acc=1):(carspeed-=.01,acc=1):180==cellinfo.angle?carrz>90&&carrz<270?(carspeed+=.01,acc=1):(carspeed-=.01,acc=1):270==cellinfo.angle&&(carrz>180&&carrz<360?(carspeed+=.01,acc=1):(carspeed-=.01,acc=1)):9==cellinfo.id?90==cellinfo.angle?carrz>270||carrz<90?(carspeed+=.01,acc=1):(carspeed-=.01,acc=1):270==cellinfo.angle?carrz>0&&carrz<180?(carspeed+=.01,acc=1):(carspeed-=.01,acc=1):0==cellinfo.angle?carrz>90&&carrz<270?(carspeed+=.01,acc=1):(carspeed-=.01,acc=1):90==cellinfo.angle&&(carrz>180&&carrz<360?(carspeed+=.01,acc=1):(carspeed-=.01,acc=1)):acc=0,cellinfo.inbounds&&0==carz&&(ev=eval(cellinfo.inbounds),(oob&&ev||!oob&&!ev)&&(collision=1,speedduringcollision=carspeed)),ev=+eval(cellinfo.fall),carz>=ev-(0==z?5:20)?(ev>0&&carz>0&&(vspeed=carz-(ev+2)),ev>0&&(carz=ev+2)):0==carz&&ev<15?(collision=1,speedduringcollision=carspeed):oob=1);else if(oob=1,carz>0&&(air=1,vspeed+=.01,carz-=vspeed,carz<0&&(carz=0,vspeed=0,air=0)),track.ice)for(i of track.ice)carx>=i[0]*size&&carx<=i[0]*size+i[2]*size&&cary>=i[1]*size&&cary<=i[1]*size+i[3]*size&&(onice=1)},justslopes=()=>{var x,y,z,cellinfo,ev;[x,y,z]=[~~(carx/size),~~(cary/size),~~(carz/sizeh)];try{cellinfo=space[x][y][z]}catch(e){}cellinfo&&(ev=+eval(cellinfo.fall),carz>=ev-(0==z?5:20)?carz>0&&ev>0&&(carz=ev+2):oob=1)};editor=(()=>{var e,r,l,a=cursorx,o=cursory,c=gridz;for(i=0;i<gridrz/90;i++)[U,R,D,L]=[R,D,L,U];if(L&&cursorx>1?cursorx--:R&&cursorx<18?cursorx++:U&&cursory>1?cursory--:D&&cursory<18&&cursory++,document.title=[cursorx,cursory,gridz],$)return mode=2,init(track),void play(musics.race[0],musics.race[0],38600,38600);if(s){if(inventory[selected][2]>0&&!space[cursorx][cursory][gridz]){for(i of(onice=0,track.ice))(gridz>0||cursorx>=i[0]&&cursorx<i[0]+i[2]&&cursory>=i[1]&&cursory<i[1]+i[3])&&(onice=1);onice||(!space[cursorx][cursory][gridz+1]||space[cursorx][cursory][gridz+1]&&5!=inventory[selected][0]&&6!=inventory[selected][0]&&7!=inventory[selected][0]&&9!=inventory[selected][0])&&(roads.push([cursorx,cursory,gridz,inventory[selected][0],0==inventory[selected][0]?0:cursorrz,0]),inventory[selected][2]--,C.$(`qty${selected}`).innerHTML=inventory[selected][2]+"/"+inventory[selected][1],draw_block(inventory[selected][0],"scene",cursorx,cursory,gridz,0,0==inventory[selected][0]||11==inventory[selected][0]?0:cursorrz,0))}var n,d,t,b,z=space[cursorx][cursory][gridz];for(i of(z&&z.linkable.u&&((n=space[d=z.linkable.u[0]][t=z.linkable.u[1]][b=z.linkable.u[2]])&&n.surrogate_of&&(n=space[d=n.surrogate_of[0]][t=n.surrogate_of[1]][b=n.surrogate_of[2]]),!n||!n.linkable.d||z.links.u||n.links.d||0==z.id&&0==n.id||roadlinks.push([[cursorx,cursory,gridz],[d,t,b]])),z&&z.linkable.r&&((n=space[d=z.linkable.r[0]][t=z.linkable.r[1]][b=z.linkable.r[2]])&&n.surrogate_of&&(n=space[d=n.surrogate_of[0]][t=n.surrogate_of[1]][b=n.surrogate_of[2]]),!n||!n.linkable.l||z.links.r||n.links.l||0==z.id&&0==n.id||roadlinks.push([[cursorx,cursory,gridz],[d,t,b]])),z&&z.linkable.d&&((n=space[d=z.linkable.d[0]][t=z.linkable.d[1]][b=z.linkable.d[2]])&&n.surrogate_of&&(n=space[d=n.surrogate_of[0]][t=n.surrogate_of[1]][b=n.surrogate_of[2]]),!n||!n.linkable.u||z.links.d||n.links.u||0==z.id&&0==n.id||roadlinks.push([[cursorx,cursory,gridz],[d,t,b]])),z&&z.linkable.l&&((n=space[d=z.linkable.l[0]][t=z.linkable.l[1]][b=z.linkable.l[2]])&&n.surrogate_of&&(n=space[d=n.surrogate_of[0]][t=n.surrogate_of[1]][b=n.surrogate_of[2]]),!n||!n.linkable.r||z.links.l||n.links.r||0==z.id&&0==n.id||roadlinks.push([[cursorx,cursory,gridz],[d,t,b]])),links(),turns(),roads))i&&barriers(i)}else if(_&&(console.log(0),space[cursorx][cursory][gridz]&&!space[cursorx][cursory][gridz].fixed)){var k=cursorx,p=cursory,u=gridz;if(console.log(1),space[k][p][u].surrogate_of&&([k,p,u]=space[k][p][u].surrogate_of),space[k][p][u].surrogates)for(i of space[k][p][u].surrogates)space[i[0]][i[1]][i[2]]=0;var g=space[k][p][u].inventoryid;for(i in inventory[g][2]++,C.$(`qty${g}`).innerHTML=inventory[g][2]+"/"+inventory[g][1],space[k][p][u].links.u&&(space[space[k][p][u].links.u[0]][space[k][p][u].links.u[1]][space[k][p][u].links.u[2]].links.d=0),space[k][p][u].links.r&&(space[space[k][p][u].links.r[0]][space[k][p][u].links.r[1]][space[k][p][u].links.r[2]].links.l=0),space[k][p][u].links.d&&(space[space[k][p][u].links.d[0]][space[k][p][u].links.d[1]][space[k][p][u].links.d[2]].links.u=0),space[k][p][u].links.l&&(space[space[k][p][u].links.l[0]][space[k][p][u].links.l[1]][space[k][p][u].links.l[2]].links.r=0),space[k][p][u]=0,C.$(`road-${k}-${p}-${u}`).remove(),roads)roads[i]&&roads[i][0]==k&&roads[i][1]==p&&roads[i][2]==u&&(roads[i]=0);for(i in roadlinks)for(j=0;j<2;j++)roadlinks[i]&&roadlinks[i][j][0]==k&&roadlinks[i][j][1]==p&&roadlinks[i][j][2]==u&&(roadlinks[i]=0);for(i of(links(),turns(),roads))i&&barriers(i)}if((rerender||L||R||U||D||S||_)&&(C.camera({x:cursorx*size+size/2,y:cursory*size+size/2,z:gridz*sizeh,rz:gridrzreal,rx:40,el:400}),C.move({n:"cursor",x:cursorx*size+size/2,y:cursory*size+size/2,z:gridz*sizeh}),rerender=0,space[cursorx][cursory][gridz]||0==inventory[selected][2]||space[cursorx][cursory][gridz+1]&&(5==inventory[selected][0]||6==inventory[selected][0]||7==inventory[selected][0]||9==inventory[selected][0])?cursor.style.background="#e668":cursor.style.background="#9f88"),s){var f=space[a][o][gridz];f&&f.surrogate_of&&([a,o,c]=f.surrogate_of,f=space[a][o][c]),r=cursory,l=gridz;var y=space[e=cursorx][r][l];if(y&&y.surrogate_of&&([e,r,l]=y.surrogate_of,y=space[e][r][l]),U){if(f&&y&&f.linkable.u&&y.linkable.d){for(i of(roadlinks.push([[a,o,c],[e,r,l]]),links(),turns(),roads))i&&barriers(i);equations()}}else if(R){if(f&&y&&f.linkable.r&&y.linkable.l){for(i of(roadlinks.push([[a,o,c],[e,r,l]]),links(),turns(),roads))i&&barriers(i);equations()}}else if(D){if(f&&y&&f.linkable.d&&y.linkable.u){for(i of(roadlinks.push([[a,o,c],[e,r,l]]),links(),turns(),roads))i&&barriers(i);equations()}}else if(L&&f&&y&&f.linkable.l&&y.linkable.r){for(i of(roadlinks.push([[a,o,c],[e,r,l]]),links(),turns(),roads))i&&barriers(i);equations()}}});var select=e=>{inventory[e]&&(document.querySelector(".part.selected").classList.remove("selected"),C.$("part"+e).classList.add("selected"),selected=e,C.$("cursor").innerHTML="",draw_block(inventory[e][0],"cursor",.1,.1),rerender=1)},race=()=>{if(timer+=.015,time.innerHTML=timer.toFixed(2).replace(".",":"),delog(),log("oob",oob),timer>=0){for(times=0;times<5;times++)carspeed>1.5&&(carspeed=1.5),carspeed<-1.5&&(carspeed=-1.5),air||onice||(u?(carspeed<(oob?.4:acc?1.5:.7)&&(carspeed+=.002),carspeed<-.7&&(carspeed+=.1),carspeed>.7&&(carspeed*=.999),(carrzd<-.5||carrzd>.5)&&(carspeed*=.991)):d?(carspeed>(oob?-.4:acc?-1.5:-.7)&&(carspeed-=.002),carspeed>.7&&(carspeed-=.1),carspeed<-.7&&(carspeed*=.999),(carrzd<-5||carrzd>.5)&&(carspeed*=.991)):carspeed*=.99,l&&u||r&&d?((carrzd-=.01)>0&&(carrzd=0),carrzd<-.8&&(carrzd=-.8),(carrz+=carrzd)<0&&(carrz+=360),carangledisplay>-15&&(carangledisplay+=carrzd)):r&&u||l&&d?(carrzd<0&&(carrzd=0),(carrzd+=.01)>.8&&(carrzd=.8),(carrz+=carrzd)>=360&&(carrz-=360),carangledisplay<15&&(carangledisplay+=carrzd)):(carangledisplay*=.99,carrzd*=.99)),carx+=carspeed*Math.sin(toRadians(carrz)),cary-=carspeed*Math.cos(toRadians(carrz)),collision?justslopes():testcollision();collision&&(carspeed=speedduringcollision>=0?-.2:.2,(collision-=.1)<=0&&(collision=0))}C.camera({x:carx,y:cary,z:carz,rz:-carrz+carangledisplay,rx:75,el:-550}),C.move({n:"car",x:carx,y:cary,z:carz,rz:carrz}),top.time&&(time.innerHTML=timer.toFixed(2).replace(".",":")),log("coll",collision),log("carspeed",carspeed.toFixed(3)),log("vspeed",vspeed),log("carrz",carrz),log("onice",onice),log("carrzd",carrzd),$&&init(track)},draw_block=(e,r,i,s,l,a,o,c)=>{var n="scene"==r?`road-${i}-${s}-${l}`:`v${r}`,d=`block${e}`;if(C.group({g:r,n:n,x:size*i+size/2,y:size*s+size/2,z:sizeh*l+1,o:"center",css:d,rx:a,rz:o}),e<4&&C.plane({g:n,w:.8*size,h:.8*size,b:"#d90",o:"center",css:d}),0==e)"scene"==r&&(space[i][s][l]={fixed:c,free:0,id:e,inventoryid:selected,linkable:{u:[i,s-1,l],r:[i+1,s,l],d:[i,s+1,l],l:[i-1,s,l]},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:1,r:1,d:1,l:1},surrogates:0,surrogate_of:0,slope:0,angle:0,fall:`${l*sizeh}`,inbounds:""});else if(1==e)C.plane({g:n,w:.8*size,h:sizeh,z:sizeh/2,rx:-88,b:"linear-gradient(90deg, #666 5px, transparent 5px, transparent 75px, #666 75px),linear-gradient(#6c4 25px,transparent 25px)",o:"center",html:"start"}),"scene"==r&&(space[i][s][l]={fixed:c,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:1,r:1,d:1,l:1},surrogates:0,surrogate_of:0,slope:0,angle:o,fall:`${l*sizeh}`,inbounds:""},start=[i,s,l],0==o?space[i][s][l].linkable.u=[i,s-1,l]:90==o?space[i][s][l].linkable.r=[i+1,s,l]:180==o?space[i][s][l].linkable.d=[i,s+1,l]:270==o&&(space[i][s][l].linkable.l=[i-1,s,l]));else if(2==e)C.plane({g:n,w:.8*size,h:sizeh,z:sizeh/2,rx:-88,b:"linear-gradient(90deg, #666 5px, transparent 5px, transparent 75px, #666 75px),linear-gradient(#d22 25px,transparent 25px)",o:"center",html:"end"}),"scene"==r&&(space[i][s][l]={fixed:c,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:1,r:1,d:1,l:1},surrogates:0,surrogate_of:0,slope:0,angle:o,fall:`${l*sizeh}`,inbounds:""},0==o?space[i][s][l].linkable.d=[i,s+1,l]:90==o?space[i][s][l].linkable.l=[i-1,s,l]:180==o?space[i][s][l].linkable.u=[i,s-1,l]:270==o&&(space[i][s][l].linkable.r=[i+1,s,l]));else if(3==e)C.plane({g:n,w:.8*size,h:sizeh,z:sizeh/2,rx:-88,b:"linear-gradient(90deg, #666 5px, transparent 5px, transparent 75px, #666 75px),linear-gradient(#5ae 25px,transparent 25px)",o:"center"}),"scene"==r&&(space[i][s][l]={fixed:c,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:1,r:1,d:1,l:1},surrogates:0,surrogate_of:0,slope:0,angle:o,fall:`${l*sizeh}`,inbounds:"",passed:0},checkpoints++,0==o?(space[i][s][l].linkable.u=[i,s-1,l],space[i][s][l].linkable.d=[i,s+1,l]):90==o?(space[i][s][l].linkable.r=[i+1,s,l],space[i][s][l].linkable.l=[i-1,s,l]):180==o?(space[i][s][l].linkable.u=[i,s-1,l],space[i][s][l].linkable.d=[i,s+1,l]):270==o&&(space[i][s][l].linkable.l=[i-1,s,l],space[i][s][l].linkable.r=[i+1,s,l]));else if(4==e)C.plane({g:n,w:.8*size,h:106,z:18,rx:-20,b:"#d00",o:"center"}),C.plane({g:n,w:.8*size,h:.2*size,y:-10,rx:-90,z:.2*sizeh,b:"linear-gradient(90deg,#666 5px,transparent 5px, transparent 75px, #666 75px)",o:"center"}),"scene"==r&&(space[i][s][l]={fixed:c,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:0,r:0,d:0,l:0},surrogates:0,surrogate_of:0,slope:1,angle:o,fall:0==o?`${l*sizeh}+(100-(cary%size))/2`:90==o?`${l*sizeh}+(carx%size)/2`:180==o?`${l*sizeh}+(cary%size)/2`:`${l*sizeh}+(100-(carx%size))/2`,inbounds:""},0==o?space[i][s][l].linkable.d=[i,s+1,l]:90==o?space[i][s][l].linkable.l=[i-1,s,l]:180==o?space[i][s][l].linkable.u=[i,s-1,l]:270==o&&(space[i][s][l].linkable.r=[i+1,s,l]));else if(5==e)C.plane({g:n,z:sizeh/2,w:.8*size,h:112,o:"center",b:"#d90",rx:-26.5}),C.plane({g:n,w:.8*size,h:44,y:-40,rx:-90,z:22,b:"linear-gradient(90deg,#666 5px,transparent 5px, transparent 75px, #666 75px)",o:"center"}),"scene"==r&&(space[i][s][l]={fixed:c,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:1,r:1,d:1,l:1},surrogates:[[i,s,l+1]],surrogate_of:0,slope:1,angle:o,fall:0==o?`${l*sizeh}+(100-(cary%size))/2`:90==o?`${l*sizeh}+(carx%size)/2`:180==o?`${l*sizeh}+(cary%size)/2`:`${l*sizeh}+(100-(carx%size))/2`,inbounds:""},0==o?(space[i][s][l].linkable.u=[i,s-1,l+1],space[i][s][l].linkable.d=[i,s+1,l]):90==o?(space[i][s][l].linkable.l=[i-1,s,l],space[i][s][l].linkable.r=[i+1,s,l+1]):180==o?(space[i][s][l].linkable.u=[i,s-1,l],space[i][s][l].linkable.d=[i,s+1,l+1]):270==o&&(space[i][s][l].linkable.l=[i-1,s,l+1],space[i][s][l].linkable.r=[i+1,s,l]),space[i][s][l+1]={fixed:c,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:1,r:1,d:1,l:1},surrogates:0,surrogate_of:[i,s,l],slope:1,angle:o,fall:0==o?`${l*sizeh}+(100-(cary%size))/2`:90==o?`${l*sizeh}+(carx%size)/2`:180==o?`${l*sizeh}+(cary%size)/2`:`${l*sizeh}+(100-(carx%size))/2`,inbounds:""});else if(6==e){if(C.plane({g:n,w:.8*size,h:107,z:17,o:"center",b:"#d90",rx:-19}),C.plane({g:n,y:-size,z:42,w:.8*size,h:107,o:"center",b:"#d90",rx:-9}),C.plane({g:n,w:.8*size,h:sizeh,y:-size-40,rx:-90,z:.4*sizeh,b:"linear-gradient(90deg,#666 5px,transparent 5px, transparent 75px, #666 75px)",o:"center"}),C.plane({g:n,w:.8*size,h:.6*sizeh,y:-40,rx:-90,z:.3*sizeh,b:"linear-gradient(90deg,#666 5px,transparent 5px, transparent 75px, #666 75px)",o:"center"}),"scene"==r){space[i][s][l]={fixed:c,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:1,r:1,d:1,l:1},surrogates:[[i,s,l+1]],surrogate_of:0,slope:1,angle:o,fall:0==o?`${l*sizeh}+(100-(cary%size))/4`:90==o?`${l*sizeh}+(carx%size)/4`:180==o?`${l*sizeh}+(cary%size)/4`:`${l*sizeh}+(100-(carx%size))/4`,inbounds:""};var t=0,b=0,z=0;0==o?(space[i][s][l].linkable.u=[i,s-2,l+1],space[i][s][l].linkable.d=[i,s+1,l],space[i][s][l].surrogates.push([t=i,b=s-1,z=l])):90==o?(space[i][s][l].linkable.l=[i-1,s,l],space[i][s][l].linkable.r=[i+2,s,l+1],space[i][s][l].surrogates.push([t=i+1,b=s,z=l])):180==o?(space[i][s][l].linkable.u=[i,s-1,l],space[i][s][l].linkable.d=[i,s+2,l+1],space[i][s][l].surrogates.push([t=i,b=s+1,z=l])):270==o&&(space[i][s][l].linkable.l=[i-2,s,l+1],space[i][s][l].linkable.r=[i+1,s,l],space[i][s][l].surrogates.push([t=i-1,b=s,z=l])),space[i][s][l].surrogates.push([t,b,z+1]),space[t][b][z]||space[t][b][z+1]?(C.$(n).remove(),space[i][s][l]=0,cursor.style.background="#e668"):(space[t][b][z]={fixed:1,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:0,r:0,d:0,l:0},surrogates:0,surrogate_of:[i,s,l],slope:1,angle:o,fall:0==o?`${l*sizeh+25}+(100-(cary%size))/4`:90==o?`${l*sizeh+25}+(carx%size)/4`:180==o?`${l*sizeh+25}+(cary%size)/4`:`${l*sizeh+25}+(100-(carx%size))/4`,inbounds:""},space[i][s][l+1]={fixed:1,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:0,r:0,d:0,l:0},surrogates:0,surrogate_of:[i,s,l],slope:1,angle:o,fall:0==o?`${l*sizeh}+(100-(cary%size))/4`:90==o?`${l*sizeh}+(carx%size)/4`:180==o?`${l*sizeh}+(cary%size)/4`:`${l*sizeh}+(100-(carx%size))/4`,inbounds:""},space[t][b][z+1]={fixed:1,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:0,r:0,d:0,l:0},surrogates:0,surrogate_of:[i,s,l],slope:1,angle:o,fall:0==o?`${l*sizeh+25}+(100-(cary%size))/4`:90==o?`${l*sizeh+25}+(carx%size)/4`:180==o?`${l*sizeh+25}+(cary%size)/4`:`${l*sizeh+25}+(100-(carx%size))/4`,inbounds:""})}}else if(7==e){if(C.plane({g:n,w:.8*size,h:103,z:7,o:"center",b:"#d90",rx:-8}),C.plane({g:n,y:-size,z:32,w:.8*size,h:105,o:"center",b:"#d90",rx:-20}),C.plane({g:n,w:.8*size,h:sizeh,y:-size-40,rx:-90,z:.4*sizeh,b:"linear-gradient(90deg,#666 5px,transparent 5px, transparent 75px, #666 75px)",o:"center"}),C.plane({g:n,w:.8*size,h:.2*sizeh,y:-40,rx:-90,z:.1*sizeh,b:"linear-gradient(90deg,#666 5px,transparent 5px, transparent 75px, #666 75px)",o:"center"}),"scene"==r){space[i][s][l]={fixed:c,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:1,r:1,d:1,l:1},surrogates:[[i,s,l+1]],surrogate_of:0,slope:1,angle:o,fall:0==o?`${l*sizeh}+(100-(cary%size))/4`:90==o?`${l*sizeh}+(carx%size)/4`:180==o?`${l*sizeh}+(cary%size)/4`:`${l*sizeh}+(100-(carx%size))/4`,inbounds:""};t=0,b=0,z=0;0==o?(space[i][s][l].linkable.u=[i,s-2,l+1],space[i][s][l].linkable.d=[i,s+1,l],space[i][s][l].surrogates.push([t=i,b=s-1,z=l])):90==o?(space[i][s][l].linkable.l=[i-1,s,l],space[i][s][l].linkable.r=[i+2,s,l+1],space[i][s][l].surrogates.push([t=i+1,b=s,z=l])):180==o?(space[i][s][l].linkable.u=[i,s-1,l],space[i][s][l].linkable.d=[i,s+2,l+1],space[i][s][l].surrogates.push([t=i,b=s+1,z=l])):270==o&&(space[i][s][l].linkable.l=[i-2,s,l+1],space[i][s][l].linkable.r=[i+1,s,l],space[i][s][l].surrogates.push([t=i-1,b=s,z=l])),space[i][s][l].surrogates.push([t,b,z+1]),space[t][b][z]||space[t][b][z+1]?(C.$(n).remove(),space[i][s][l]=0,window.cursor&&(cursor.style.background="#e668")):(space[t][b][z]={fixed:1,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:0,r:0,d:0,l:0},surrogates:0,surrogate_of:[i,s,l],slope:1,angle:o,fall:0==o?`${l*sizeh+25}+(100-(cary%size))/4`:90==o?`${l*sizeh+25}+(carx%size)/4`:180==o?`${l*sizeh+25}+(cary%size)/4`:`${l*sizeh+25}+(100-(carx%size))/4`,inbounds:""},space[i][s][l+1]={fixed:1,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:0,r:0,d:0,l:0},surrogates:0,surrogate_of:[i,s,l],slope:1,angle:o,fall:0==o?`${l*sizeh}+(100-(cary%size))/4`:90==o?`${l*sizeh}+(carx%size)/4`:180==o?`${l*sizeh}+(cary%size)/4`:`${l*sizeh}+(100-(carx%size))/4`,inbounds:""},space[t][b][z+1]={fixed:1,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:0,r:0,d:0,l:0},surrogates:0,surrogate_of:[i,s,l],slope:1,angle:o,fall:0==o?`${l*sizeh+25}+(100-(cary%size))/4`:90==o?`${l*sizeh+25}+(carx%size)/4`:180==o?`${l*sizeh+25}+(cary%size)/4`:`${l*sizeh+25}+(100-(carx%size))/4`,inbounds:""})}}else if(8==e)C.plane({g:n,w:.8*size,h:size,o:"center",css:"acc2"}),"scene"==r&&(space[i][s][l]={fixed:c,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:1,r:1,d:1,l:1},surrogate:0,slope:0,angle:o,fall:`${l*sizeh}`,inbounds:""},0==o?(space[i][s][l].linkable.u=[i,s-1,l],space[i][s][l].linkable.d=[i,s+1,l]):90==o?(space[i][s][l].linkable.l=[i-1,s,l],space[i][s][l].linkable.r=[i+1,s,l]):180==o?(space[i][s][l].linkable.u=[i,s-1,l],space[i][s][l].linkable.d=[i,s+1,l]):270==o&&(space[i][s][l].linkable.l=[i-1,s,l],space[i][s][l].linkable.r=[i+1,s,l]));else if(9==e)C.plane({g:n,w:.8*size,h:112,z:sizeh/2,o:"center",css:"acc",rx:-26.5}),C.plane({g:n,w:.8*size,h:44,y:-40,rx:-90,z:22,b:"linear-gradient(90deg,#666 5px,transparent 5px, transparent 75px, #666 75px)",o:"center"}),"scene"==r&&(space[i][s][l]={fixed:c,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:1,r:1,d:1,l:1},surrogates:[[i,s,l+1]],surrogate_of:0,slope:1,angle:o,fall:0==o?`${l*sizeh}+(100-(cary%size))/2`:90==o?`${l*sizeh}+(carx%size)/2`:180==o?`${l*sizeh}+(cary%size)/2`:`${l*sizeh}+(100-(carx%size))/2`,inbounds:""},0==o?(space[i][s][l].linkable.u=[i,s-1,l+1],space[i][s][l].linkable.d=[i,s+1,l]):90==o?(space[i][s][l].linkable.l=[i-1,s,l],space[i][s][l].linkable.r=[i+1,s,l+1]):180==o?(space[i][s][l].linkable.u=[i,s-1,l],space[i][s][l].linkable.d=[i,s+1,l+1]):270==o&&(space[i][s][l].linkable.l=[i-1,s,l+1],space[i][s][l].linkable.r=[i+1,s,l]),space[i][s][l+1]={fixed:1,free:0,id:e,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:1,r:1,d:1,l:1},surrogates:0,surrogate_of:[i,s,l],slope:1,angle:o,fall:0==o?`${l*sizeh}+(100-(cary%size))/2`:90==o?`${l*sizeh}+(carx%size)/2`:180==o?`${l*sizeh}+(cary%size)/2`:`${l*sizeh}+(100-(carx%size))/2`,inbounds:""});else if(10==e)C.plane({g:n,w:.8*size,h:112,z:sizeh/2,o:"center",css:"acc2",rx:-26.5}),C.plane({g:n,w:.8*size,h:44,y:-40,rx:-90,z:22,b:"linear-gradient(90deg,#666 5px,transparent 5px, transparent 75px, #666 75px)",o:"center"}),"scene"==r&&(space[i][s][l]={fixed:c,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:1,r:1,d:1,l:1},surrogates:[[i,s,l+1]],surrogate_of:0,slope:1,angle:o,fall:0==o?`${l*sizeh}+(100-(cary%size))/2`:90==o?`${l*sizeh}+(carx%size)/2`:180==o?`${l*sizeh}+(cary%size)/2`:`${l*sizeh}+(100-(carx%size))/2`,inbounds:""},0==o?(space[i][s][l].linkable.u=[i,s-1,l+1],space[i][s][l].linkable.d=[i,s+1,l]):90==o?(space[i][s][l].linkable.l=[i-1,s,l],space[i][s][l].linkable.r=[i+1,s,l+1]):180==o?(space[i][s][l].linkable.u=[i,s-1,l],space[i][s][l].linkable.d=[i,s+1,l+1]):270==o&&(space[i][s][l].linkable.l=[i-1,s,l+1],space[i][s][l].linkable.r=[i+1,s,l]),space[i][s][l+1]={fixed:1,free:0,id:e,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:1,r:1,d:1,l:1},surrogates:0,surrogate_of:[i,s,l],slope:1,angle:o,fall:0==o?`${l*sizeh}+(100-(cary%size))/2`:90==o?`${l*sizeh}+(carx%size)/2`:180==o?`${l*sizeh}+(cary%size)/2`:`${l*sizeh}+(100-(carx%size))/2`,inbounds:""});else if(12==e)"scene"==r||"vcursor"==r?C.sprite({g:n,w:size,h:size,y:0,z:0,rx:-90,html:"🌲",css:"tree",o:"bottom"}):C.plane({g:n,w:size,h:size,y:0,z:-20,rx:-80,html:"🌲",css:"tree",o:"bottom"}),"scene"==r&&(space[i][s][l]={fixed:c,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:0,r:0,d:0,l:0},surrogates:0,surrogate_of:0,slope:0,angle:0,fall:"",inbounds:`dist2([carx,cary],[${i*size+size/2},${s*size+size/2}])>20**2`},space[i][s][l+1]={fixed:c,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:0,r:0,d:0,l:0},surrogates:0,surrogate_of:0,slope:0,angle:0,fall:"",inbounds:`dist2([carx,cary],[${i*size+size/2},${s*size+size/2}])>20**2`});else if(13==e)if("scene"==r){C.cube({g:n,w:100,h:sizeh*l+sizeh,z:-sizeh*l-1,d:100,b:"#aaa",b2:"#777",b3:"#999"}),space[i][s][l]={fixed:c,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:1,r:1,d:1,l:1},surrogates:[],surrogate_of:0,slope:0,angle:0,fall:"",inbounds:""};for(z=0;z<l;z++)space[i][s][z]={fixed:c,free:0,id:e,inventoryid:selected,linkable:{u:0,r:0,d:0,l:0},links:{u:0,r:0,d:0,l:0},flat:{u:1,r:1,d:1,l:1},barriers:{u:1,r:1,d:1,l:1},surrogates:0,surrogate_of:[i,s,l],slope:0,angle:0,fall:"",inbounds:""},space[i][s][l].surrogates.push([i,s,z])}else C.cube({g:n,w:100,h:sizeh,d:100,b:"#aaa",b2:"#777",b3:"#999"});l>0&&4!=e&&0!=e&&e<11&&(C.plane({g:n,w:.8*size,h:sizeh*l,y:-40,z:sizeh*(-l/2),rx:-90,b:"linear-gradient(90deg,#666 5px,transparent 5px, transparent 75px, #666 75px)",o:"center"}),C.plane({g:n,w:.8*size,h:sizeh*l,y:40,z:sizeh*(-l/2),rx:-90,b:"linear-gradient(90deg,#666 5px,transparent 5px, transparent 75px, #666 75px)",o:"center"}))};onkeydown=onkeyup=(e=>top["lurdl*d*l_ur*u*s$***"[(e.which+3)%20]]=top["LURDL*D*L_UR*U*S$***"[(e.which+3)%20]]=e.type[5]),ui=(()=>{gridup.onclick=(()=>{gridz<10&&gridz++,C.move({n:"grid",z:gridz*sizeh}),C.move({n:"cursor",z:gridz*sizeh}),rerender=1}),griddown.onclick=(()=>{gridz&&gridz--,C.move({n:"grid",z:gridz*sizeh}),C.move({n:"cursor",z:gridz*sizeh}),rerender=1}),gridrl.onclick=(()=>{0==gridrz&&(gridrz=360),gridrz-=90,gridrzreal-=90,C.camera({rz:gridrzreal})}),gridrr.onclick=(()=>{360==gridrz&&(gridrz=0),gridrz+=90,gridrzreal+=90,C.camera({rz:gridrzreal})}),blockrl.onclick=(()=>{cursorrzreal-=90,-90==(cursorrz-=90)&&(cursorrz=270),C.move({n:"cursor",rz:cursorrzreal})}),blockrr.onclick=(()=>{cursorrzreal+=90,360==(cursorrz+=90)&&(cursorrz=0),C.move({n:"cursor",rz:cursorrzreal})}),blockc.onclick=(()=>{b.innerHTML="",init(originaltrack)}),exp.onclick=(()=>{var e=JSON.parse(JSON.stringify(roads));for(i of e=e.filter(e=>0!=e));var r=JSON.parse(JSON.stringify(roadlinks));r=r.filter(e=>0!=e),prompt("export:",location+"#"+btoa(JSON.stringify({roads:e,roadlinks:r,inventory:[]})))}),load.onclick=(()=>{var e=JSON.parse(prompt("import:",""));b.innerHTML="",e&&init(e)})});var cl=onclick=(()=>{if(0==mode){var e="<div class=m><h1>Snow</h1>";for(i=1;i<7;i++)e+="<div onclick='mode = 1; init(levels.A"+i+"); play(musics.editor[0],musics.editor[1],1100,16600)'>"+i+"</div>";for(e+="<br><br><h1>Desert</h1>",i=1;i<7;i++)e+="<div onclick='A.close(); mode = 1; init(levels.B"+i+"); play(musics.editor[0],musics.editor[1],1100,16600)'>"+i+"</div>";e+="<br><br><h1>More levels</h1><a href='xem.github.iom/js13k19/more'>soon!</a>",document.monetization,e+="<br><br><h1>Coil bonus</h1><div onclick='mode=1;init(levels.editor);play(musics.editor[0],musics.editor[1],1100,16600)'>Track editor</div>",b.innerHTML=e,mode=99,play(musics.menu[0],musics.menu[0],7100,7100)}}),init=(e={})=>{for(navigator.userAgent.includes("Fir")&&(document.body.className="fx"),originaltrack=e,track=JSON.parse(JSON.stringify(e)),i=0;i<20;i++)for(space[i]=[],j=0;j<20;j++)space[i][j]=[];if(b.innerHTML="<div id=viewport><div id=camera><div id=scene>",0==mode){for(i of(b.className="menu",roads=track.roads||[],roadlinks=track.roadlinks||[],roads))i&&draw_block(i[3],"scene",i[0],i[1],i[2],0,i[4],0);for(i of(C.camera({x:900,y:1300,z:900,rx:25}),links(),roads))i&&barriers(i);turns()}else if(1==mode){for(b.className="editor",b.innerHTML+='<textarea id=deb rows=1 cols=1></textarea><div id=menu>Camera<br>\n    <div id=gridup>⇑</div> <div id=griddown>⇓</div> <div id=gridrl>↶</div> <div id=gridrr>↷</div><br>⎯<br>Block<br><div id=blockrl>↶</div> <div id=blockrr>↷</div><br><br><p>Add: <b>space+wasd</b> Remove: <b>Del</b><br>Play/retry: <b>Enter</b></p>⎯<br><div id=blockc style=width:120px>Clear all</div><div id=exp>Export</div> <div id=load>Load</div>⎯<br><div onclick="mode = 0; init(); cl()">Exit',b.innerHTML+="<div id=parts>",inventory=track.inventory||[],i=0;i<Math.max(6,inventory.length);i++)selected=0,parts.innerHTML+=`<div class="part ${0==i?"selected":""}" id=part${i} onclick=select(${i})><div class=visual id=visual${i}></div><div class=remaining id=qty${i}>`;for(i of(gridz=0,C.plane({n:"grid",w:20*size,h:20*size,o:"top left"}),roads=track.roads||[]))i&&(draw_block(i[3],"scene",i[0],i[1],i[2],0,i[4],5==i.length?1:0),1==i[3]&&(cursorx=cx=i[0],carx=cx*size+size/2,cursory=cy=i[1],cary=cy*size+size/2,gridz=cz=i[2],carz=cz*sizeh,C.move({n:"grid",z:gridz*sizeh})));for(i in roadlinks=track.roadlinks||[],inventory)j=inventory[i],C.$(`qty${i}`).innerHTML=`${j[2]}/${j[1]}`,draw_block(j[0],`visual${i}`,6==j[0]||7==j[0]?-.7:-.5,6==j[0]||7==j[0]?-.2:-.4,6==j[0]||7==j[0]?-25:-15,50,30);for(i of ice=track.ice||[])C.plane({x:i[0]*size,y:i[1]*size,w:i[2]*size,h:i[3]*size,css:"ice",o:"top left",bp:-i[0]*size+C.unit+" "+-i[1]*size+C.unit});for(i of(C.group({n:"cursor",w:1.2*size,h:1.2*size,x:cursorx*size+size/2,y:cursory*size+size/2,z:gridz*sizeh,o:"center"}),select(0),rerender=1,links(),roads))i&&barriers(i);turns(),equations(),ui()}else if(2==mode){for(i of(carrz=0,carx=start[0]*size+size/2,cary=start[1]*size+size/2,carz=start[2]*size+size/2,b.innerHTML="<textarea id=deb rows=7 cols=180></textarea><div id=viewport><div id=camera><div id=scene></div></div><h1 onclick='mode=1;init(track); play(musics.editor[0],musics.editor[1],1100,16600)'>X</h1><h1 id=time></h1><h1 id=speed>",carz+=20,C.group({n:"car",w:0,h:0,rz:90,x:carx,y:cary,z:carz}),C.cube({g:"car",b:"#a33",b2:"#922",b3:"#c44",w:9,d:10,h:4,z:2}),C.cube({g:"car",b:"#a33",b2:"#922",b3:"#c44",w:9,d:5,h:3,z:6}),C.plane({g:"car",b:"#555",w:1.2,h:3.9,rx:90,ry:0,x:5.2,y:4,z:3}),C.plane({g:"car",b:"#555",w:1.2,h:3.9,rx:90,ry:0,x:5.2,y:-4,z:3}),C.plane({g:"car",b:"#555",w:1.2,h:3.9,rx:90,ry:0,x:-5.2,y:4,z:3}),C.plane({g:"car",b:"#555",w:1.2,h:3.9,rx:90,ry:0,x:-5.2,y:-4,z:3}),checkpoints=0,roads))i&&draw_block(i[3],"scene",i[0],i[1],i[2],0,i[4],0);for(i of ice)C.plane({x:i[0]*size,y:i[1]*size,w:i[2]*size,h:i[3]*size,css:"ice",o:"top left",bp:-i[0]*size+C.unit+" "+-i[1]*size+C.unit});for(i of(links(),roads))i&&barriers(i);turns(),b.className="race",equations(),timer=-1,speeder=0,air=1,vspeed=0,carspeed=0}else if(3==mode){var r="<div class=s>Score: "+timer.toFixed(2).replace(".",":");timer<=track.gold?r+="<br>🥇 GOLD":timer<=track.silver?r+="<br>🥈 SILVER<br>(gold: "+track.gold+":00)":timer<=track.silver?r+="<br>🥉 SILVER<br>(silver: "+track.silver+":00)":r+="<br>(bronze: "+track.bronze+":00)",r+="<div onclick='mode=1;init(track); play(musics.editor[0],musics.editor[1],1100,16600)'>Return to editor",b.innerHTML=r}};mode=0,init(levels.title),setInterval(()=>{1==mode?editor():2==mode&&race(),S=_=U=L=D=R=0},16);
</script>

</div>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:calibri;cursor:pointer;user-select:none;-moz-user-select:none;}
#viewport{width:100vw;height:100vh;background:#fff;overflow:hidden;position:relative;perspective:700px}
#viewport *,.part *{transform-style:preserve-3d;box-sizing:border-box}
#camera{width:0;height:0;position:absolute;top:55%;left:50%}

.circle{border-radius:50%}
#deb{position:fixed;top:0;left:0;z-index:2;xtop:-999px;font-size:10px}
.plane{text-align:center;font-size:25px;line-height:20px}
.block0.z0{border:1px solid #ddd}
.barrierleftright.z0{border-left:5px solid #000;border-right:5px solid #000}
.barriertopbottom.z0{border-top:5px solid #000;border-bottom:5px solid #000}

/* Menu */
.m, .s { text-align: center; position: fixed; top: 50%; margin: -250px 0 0; width: 100%; }
.m div, .m a { padding: 5px 15px; font-size: 30px; border: 1px solid; display: inline-block; margin: 5px; background: #d90; }

/* Editor CSS */
#grid { background: linear-gradient(#888 2px, transparent 2px), linear-gradient(90deg, #888 2px, transparent 2px),#def8; background-size: 100px 100px; }
#menu { position: fixed; left: 0; top: 0; text-align:center; width: 145px; background: #fff; padding: 5px; border: 2px solid}
#menu div { width: 60px; display: inline-block; height: 30px; border: 2px solid #555; background:#eee; font-size: 20px; margin: 2px 0;}
#parts { position: fixed; bottom: 0; text-align:center; width: 100%; }
.part { width: 60px; height: 80px; border: 2px solid #555; background:#ddd; display: inline-block; vertical-align: top; perspective: 500px;}

.part.selected { background: #fff }
.visual { height: 30px; margin: 25px 30px 0; }
.fx .editor #scene{ transition:.2s linear }
p{text-align:left;background:#eee; margin: 0 2px; padding: 5px}
#cursor { transition:.1s linear }
.tree { font-size: 90px; line-height: 90px; text-align: center; }
.ice { border-radius: 25px; background: #def; background: linear-gradient(45deg, #def, #cde, #def, #cde, #def); background-size: 2000px 2000px; }

/* Parts CSS */
.acc { background: linear-gradient(70deg, transparent 75%, #fd3 75%) center center, linear-gradient(-70deg, #d90 75%, #fd3 75%) center center,#d90; background-size: 26px 24px; }

.acc2 { background: linear-gradient(110deg, transparent 75%, #fd3 75%) center center, linear-gradient(-110deg, #d90 75%, #fd3 75%) center center,#d90; background-size: 26px 24px; }


/*.hole { background: radial-gradient(transparent 45%,#d90 45%);}*/

/* race */
.race #viewport { background: linear-gradient(#def 10%,#fff 15%); }
.editor h1, .race h1 {position: fixed; right: 10px }
#time { right: auto; left: 10px; }
#speed { bottom : 0px; }

/* score */
.s { font-size: 50px; }
.s div { width: 400px; height: 60px; font-size: 50px; border: 2px solid; margin: 50px auto; background: #d90; }