<body id=b>
<script>C={unit:"px",camX:0,camY:0,camZ:0,camRX:0,camRY:0,camRZ:0,plane_count:0,cube_count:0,options:{},$:r=>document.getElementById(r),init:r=>{r.css||(r.css=""),r.html||(r.html=""),r.g||(r.g="scene"),r.o||(r.o="center"),"bottom"==r.o&&(r.y-=r.h/2),r.w||(r.w=0),r.h||(r.h=0),r.x||(r.x=0),r.y||(r.y=0),r.z||(r.z=0),r.rx||(r.rx=0),r.ry||(r.ry=0),r.rz||(r.rz=0),r.sx||(r.sx=1),r.sy||(r.sy=1),r.sz||(r.sz=1),C.options[r.n]=r},group:r=>{r.d||0===r.d||(r.d=r.h),C.init(r),C.$(r.g).innerHTML+=`<div id="${r.n}"class="group ${r.css}"style="position:absolute;width:${r.w}${C.unit};height:${r.d}${C.unit};background:${r.b};transform:${C.tr(r)}">`},plane:r=>{r.n||(r.n=`plane${C.plane_count++}`),C.init(r),C.$(r.g).innerHTML+=`<div id="${r.n}"class="plane ${r.css}"style="position:absolute;width:${r.w}${C.unit};height:${r.h}${C.unit};background:${r.b};transform-origin:${r.o};transform:${C.tr(r)}">${r.html}`,C.camera()},cube:r=>{r.n||(r.n=`cube${C.cube_count++}`),C.init(r),C.group(r),C.plane({g:r.n,x:r.w/2,y:r.d/2,w:r.w,h:r.d,b:r.b,css:"bottom"}),C.plane({g:r.n,y:r.d/2,w:r.d,h:r.h,b:r.b,rx:-90,ry:-90,o:"bottom",css:"left"}),C.plane({g:r.n,x:r.w,y:r.d/2,w:r.d,h:r.h,b:r.b3,rx:-90,ry:-90,o:"bottom",css:"right"}),C.plane({g:r.n,x:r.w/2,y:0,w:r.w,h:r.h,b:r.b2,rx:-90,o:"bottom",css:"back"}),C.plane({g:r.n,x:r.w/2,y:r.d,w:r.w,h:r.h,b:r.b2,rx:-90,o:"bottom",css:"front"}),C.plane({g:r.n,x:r.w/2,y:r.d/2,z:r.h,w:r.w,h:r.d,b:r.b,css:"top"})},camera:r=>{r&&(r.x||0===r.x)&&(C.camX=r.x),r&&(r.y||0===r.y)&&(C.camY=r.y),r&&(r.z||0===r.z)&&(C.camZ=r.z),r&&(r.rx||0===r.rx)&&(C.camRX=r.rx),r&&(r.ry||0===r.ry)&&(C.camRY=r.ry),r&&(r.rz||0===r.rz)&&(C.camRZ=r.rz),C.camX+=(Math.random()-.5)/1e3,scene.style.transformOrigin=`${C.camX}${C.unit} ${C.camY}${C.unit}`,scene.style.transform=`translateX(${-C.camX}${C.unit})translateY(${-C.camY}${C.unit})translateZ(${-C.camZ}${C.unit})rotateX(${C.camRX}deg)rotateY(${C.camRY}deg)rotateZ(${C.camRZ}deg)`},move:r=>{if(r.n){var e=C.$(r.n),i=C.options[r.n];(r.x||0===r.x)&&(i.x=r.x),(r.y||0===r.y)&&(i.y=r.y),(r.z||0===r.z)&&(i.z=r.z),(r.rx||0===r.rx)&&(i.rx=r.rx),(r.ry||0===r.ry)&&(i.ry=r.ry),(r.rz||0===r.rz)&&(i.rz=r.rz),C.options[r.n]=i,e.style.transform=C.tr(i)}},tr:r=>`${"top left"==r.o?"":"translateX(-50%)translateY(-50%)"}translateX(${r.x}${C.unit})translateY(${r.y}${C.unit})translateZ(${r.z}${C.unit})rotateX(${r.rx}deg)rotateY(${r.ry}deg)rotateZ(${r.rz}deg)`};var mode=1,world=0,puzzle=0,race=0,size=100,sizeh=50,s=0,u=0,l=0,d=0,r=0,S=0,U=0,L=0,D=0,R=0,_=0,$=0,cx=25,cy=25,cz=30,crx=55,cry=0,crz=0,carx=10*size+size/2,cary=16*size+size/2,carrz=0,carspeed=0,front=[0,0,0],back=[0,0,0],frontcell=[0,0],backcell=[0,0],oob=0,collision=0,speedduringcollision=0,fcell,bcell,fcellinfo,bcellinfo,space=[],roads=[],roadlinks=[],gridz=0,gridrz=0,gridrzreal=0,cursorx=0,cursory=0,cursorrz=0,cursorrzreal=0,selected=0,rerender=0,inventory=[],ev,i,j,k,x,y,z,block,times,toRadians=r=>r*(Math.PI/180),dist2=(r,e)=>(r[0]-e[0])**2+(r[1]-e[1])**2,delog=()=>deb.innerHTML="",log=(...r)=>deb.innerHTML+=r+"\n",barriers=r=>{[x,y,z]=r,0==z&&(block=space[x][y][z])&&(C.$(`road-${x}-${y}-${z}`).children[0].style.border="0",block.barriers={u:0,r:0,d:0,l:0},block.u+block.r+block.d+block.l>0&&(block.u||block.d?block.l||block.r?block.u&&block.l&&!block.r&&!block.d?(block.barriers.r=1,block.barriers.d=1):block.u&&!block.l&&block.r&&!block.d?(block.barriers.l=1,block.barriers.d=1):!block.u&&block.l&&!block.r&&block.d&&(block.barriers.r=1,block.barriers.u=1):(block.barriers.l=1,block.barriers.r=1):(block.barriers.u=1,block.barriers.d=1),!block.u&&!block.l&&block.r&&block.d?(block.barriers.u=1,block.barriers.l=1):block.u+block.r+block.d+block.l==3&&(block.u||(block.barriers.u=1),block.r||(block.barriers.r=1),block.d||(block.barriers.d=1),block.l||(block.barriers.l=1))),block.barriers.u&&(C.$(`road-${x}-${y}-${z}`).children[0].style.borderTop="5px solid #000"),block.barriers.d&&(C.$(`road-${x}-${y}-${z}`).children[0].style.borderBottom="5px solid #000"),block.barriers.l&&(C.$(`road-${x}-${y}-${z}`).children[0].style.borderLeft="5px solid #000"),block.barriers.r&&(C.$(`road-${x}-${y}-${z}`).children[0].style.borderRight="5px solid #000"))},links=()=>{for(j of document.querySelectorAll(".barrierleftright,.barriertopbottom"))j.remove();for(i of roadlinks)i&&(i[0][0]==i[1][0]&&i[0][2]==i[1][2]&&i[0][1]==i[1][1]-1&&(C.plane({w:.8*size,h:.2*size,x:i[0][0]*size+.1*size,y:i[0][1]*size+.9*size,z:.2,b:"#d90",o:"top left",css:"barrierleftright"}),space[i[0][0]][i[0][1]][i[0][2]].d=1,space[i[1][0]][i[1][1]][i[1][2]].u=1),i[0][0]==i[1][0]&&i[0][2]==i[1][2]&&i[0][1]==i[1][1]+1&&(C.plane({w:.8*size,h:.2*size,x:i[1][0]*size+.1*size,y:i[1][1]*size+.9*size,z:.2,b:"#d90",o:"top left",css:"barrierleftright"}),space[i[0][0]][i[0][1]][i[0][2]].u=1,space[i[1][0]][i[1][1]][i[1][2]].d=1),i[0][0]==i[1][0]-1&&i[0][2]==i[1][2]&&i[0][1]==i[1][1]&&(C.plane({w:.2*size,h:.8*size,x:i[0][0]*size+.9*size,y:i[1][1]*size+.1*size,z:.2,b:"#d90",o:"top left",css:"barriertopbottom"}),space[i[0][0]][i[0][1]][i[0][2]].r=1,space[i[1][0]][i[1][1]][i[1][2]].l=1),i[0][0]==i[1][0]+1&&i[0][2]==i[1][2]&&i[0][1]==i[1][1]&&(C.plane({w:.2*size,h:.8*size,x:i[1][0]*size+.9*size,y:i[1][1]*size+.1*size,z:.2,b:"#d90",o:"top left",css:"barriertopbottom"}),space[i[0][0]][i[0][1]][i[0][2]].l=1,space[i[1][0]][i[1][1]][i[1][2]].r=1))},turns=()=>{for(i of roads)i&&([x,y,z]=i,(block=space[x][y][z]).flat={u:1,r:1,d:1,l:1},block.u&&block.r&&!block.d&&!block.l?(C.$(`road-${x}-${y}-${z}`).children[0].style.borderRadius="0 0 0 100%",block.flat.d=0,block.flat.l=0):!block.u&&block.r&&block.d&&!block.l?(C.$(`road-${x}-${y}-${z}`).children[0].style.borderRadius="100% 0 0 0",block.flat.u=0,block.flat.l=0):!block.u&&!block.r&&block.d&&block.l?(C.$(`road-${x}-${y}-${z}`).children[0].style.borderRadius="0 100% 0 0",block.flat.u=0,block.flat.r=0):block.u&&!block.r&&!block.d&&block.l?(C.$(`road-${x}-${y}-${z}`).children[0].style.borderRadius="0 0 100% 0",block.flat.d=0,block.flat.r=0):C.$(`road-${x}-${y}-${z}`)&&(C.$(`road-${x}-${y}-${z}`).children[0].style.borderRadius="0",block.flat.u=0,block.flat.r=0,block.flat.d=0,block.flat.l=0))},equations=()=>{for(i of roads)i&&([x,y,z]=i,(block=space[x][y][z]).u&&block.r&&!block.d&&!block.l?block.equation=`dist2([x,y],[${x*size+size},${y*size}])>(size*.8)**2`:!block.u&&block.r&&block.d&&!block.l?block.equation=`dist2([x,y],[${x*size+size},${y*size+size}])>(size*.8)**2`:!block.u&&!block.r&&block.d&&block.l?block.equation=`dist2([x,y],[${x*size},${y*size+size}])>(size*.8)**2`:block.u&&!block.r&&!block.d&&block.l?block.equation=`dist2([x,y],[${x*size},${y*size}])>(size*.8)**2`:block.equation="false")},testcollision=(f,fcell,fcellinfo)=>{[x,y,z]=fcell;try{fcellinfo=space[x][y][z]}catch(r){}fcellinfo?fcellinfo.u+fcellinfo.r+fcellinfo.d+fcellinfo.l==0?oob=0:(("false"!=fcellinfo.equation&&!oob||"false"==fcellinfo.equation&&oob)&&(oob=0),fcellinfo.barriers.u&&fcellinfo.flat.u&&f[1]%size<.2*size?collision=1:fcellinfo.barriers.r&&fcellinfo.flat.r&&f[0]%size>.8*size?(collision=1,speedduringcollision=carspeed):fcellinfo.barriers.d&&fcellinfo.flat.d&&f[1]%size>.8*size?(collision=1,speedduringcollision=carspeed):fcellinfo.barriers.l&&fcellinfo.flat.l&&f[0]%size<.2*size?(collision=1,speedduringcollision=carspeed):"false"==fcellinfo.equation||oob?"false"!=fcellinfo.equation&&oob&&([x,y,z]=f,ev=eval(fcellinfo.equation),0==ev&&(collision=1,speedduringcollision=carspeed)):([x,y,z]=f,ev=eval(fcellinfo.equation),1==ev&&(collision=1,speedduringcollision=carspeed))):oob=1};editor=(()=>{var r=cursorx,e=cursory;for(i=0;i<gridrz/90;i++)[U,R,D,L]=[R,D,L,U];if(L?cursorx--:R?cursorx++:U?cursory--:D&&cursory++,s)inventory[selected][2]>0&&!space[cursorx][cursory][gridz]&&(draw_block(inventory[selected][0],"scene",cursorx,cursory,gridz,0,cursorrz),space[cursorx][cursory][gridz]={type:inventory[selected][0],angle:cursorrz,u:0,r:0,d:0,l:0,barriers:{u:0,r:0,d:0,l:0}},roads.push([cursorx,cursory,gridz,inventory[selected][0],0,0,0]),inventory[selected][2]--,C.$(`qty${selected}`).innerHTML=inventory[selected][2]+"/"+inventory[selected][1]);else if(_){for(i in space[cursorx][cursory][gridz]&&!space[cursorx][cursory][gridz].fixed&&(C.$(`road-${cursorx}-${cursory}-${gridz}`).remove(),space[cursorx][cursory][gridz]=0),inventory[selected][2]++,C.$(`qty${selected}`).innerHTML=inventory[selected][2]+"/"+inventory[selected][1],roads)roads[i]&&roads[i][0]==cursorx&&roads[i][1]==cursory&&roads[i][2]==gridz&&(roads[i]=0);for(i in roadlinks)for(j=0;j<2;j++)roadlinks[i]&&roadlinks[i][j][0]==cursorx&&roadlinks[i][j][1]==cursory&&roadlinks[i][j][2]==gridz&&(space[roadlinks[i][j][0]-1][roadlinks[i][j][1]][gridz]&&(space[roadlinks[i][j][0]-1][roadlinks[i][j][1]][gridz].r=0),space[roadlinks[i][j][0]][roadlinks[i][j][1]-1][gridz]&&(space[roadlinks[i][j][0]][roadlinks[i][j][1]-1][gridz].d=0),space[roadlinks[i][j][0]+1][roadlinks[i][j][1]][gridz]&&(space[roadlinks[i][j][0]+1][roadlinks[i][j][1]][gridz].l=0),space[roadlinks[i][j][0]][roadlinks[i][j][1]+1][gridz]&&(space[roadlinks[i][j][0]][roadlinks[i][j][1]+1][gridz].u=0),roadlinks[i]=0);for(i of(links(),turns(),roads))i&&barriers(i)}if((rerender||L||R||U||D||S||_)&&(C.camera({x:cursorx*size+size/2,y:cursory*size+size/2,z:600+gridz*sizeh,rz:gridrzreal,rx:30}),C.move({n:"cursor",x:cursorx*size+size/2,y:cursory*size+size/2,z:gridz*sizeh}),rerender=0,space[cursorx][cursory][gridz]||0==inventory[selected][2]?cursor.style.background="#e668":cursor.style.background="#9f88"),s&&(U||R||D||L)&&space[r][e][gridz]&&0==space[r][e][gridz].type&&space[cursorx][cursory][gridz]&&0==space[cursorx][cursory][gridz].type)for(i of(roadlinks.push([[r,e,gridz],[cursorx,cursory,gridz]]),links(),turns(),roads))i&&barriers(i)});var select=r=>{inventory[r]&&(document.querySelector(".part.selected").classList.remove("selected"),C.$("part"+r).classList.add("selected"),selected=r,C.$("cursor").innerHTML="",draw_block(inventory[r][0],"cursor",.1,.1))},draw_block=(r,e,i,o,s,l,c)=>{console.log("scene"==e);var a="scene"==e?`road-${i}-${o}-${s}`:`v${e}`,n=`block${r}`;C.group({g:e,n:a,x:size*i+size/2,y:size*o+size/2,z:sizeh*s+1,o:"center",css:n,rx:l,rz:c}),r<4&&C.plane({g:a,w:.8*size,h:.8*size,b:"#d90",o:"center",css:n}),1==r?C.plane({g:a,w:size,h:size,z:sizeh,rx:-88,b:"linear-gradient(90deg, #000 5px, transparent 5px, transparent 95px, #000 95px),linear-gradient(#6c4 50px,transparent 50px)",o:"center",html:"start"}):2==r?C.plane({g:a,w:size,h:size,z:sizeh,rx:-88,b:"linear-gradient(90deg, #000 5px, transparent 5px, transparent 95px, #000 95px),linear-gradient(#d22 50px,transparent 50px)",o:"center",html:"end"}):3==r?C.plane({g:a,w:size,h:size,z:sizeh,rx:-88,b:"linear-gradient(90deg, #000 5px, transparent 5px, transparent 95px, #000 95px),linear-gradient(#5ae 50px,transparent 50px)",o:"center"}):4==r?C.plane({g:a,w:size,h:.7*size,y:.2*size,z:sizeh/4,rx:-20,b:"#d00",o:"center"}):5==r?C.plane({g:a,z:sizeh/2,w:.8*size,h:1.2*size,o:"center",b:"#d90",rx:23}):6==r?(C.plane({g:a,w:.8*size,h:1.05*size,z:.36*sizeh,o:"center",b:"#d90",rx:-20}),C.plane({g:a,y:-size,z:.84*sizeh,w:.8*size,h:1.05*size,o:"center",b:"#d90",rx:-5})):7==r?(C.plane({g:a,w:.8*size,h:1.05*size,z:.2*sizeh,o:"center",b:"#d90",rx:-5}),C.plane({g:a,y:-size,z:.66*sizeh,w:.8*size,h:1.05*size,o:"center",b:"#d90",rx:-20})):8==r?C.plane({g:a,z:1,w:.8*size,h:size,o:"center",css:"acc"}):9==r&&C.plane({g:a,w:.8*size,h:1.2*size,z:sizeh/2,o:"center",css:"acc",rx:23})};onkeydown=onkeyup=(r=>top["lurdl*d*l_ur*u*s$***"[(r.which+3)%20]]=top["LURDL*D*L_UR*U*S$***"[(r.which+3)%20]]=r.type[5]),gridup.onclick=(()=>{gridz<10&&gridz++,C.move({n:"grid",z:gridz*sizeh}),C.move({n:"cursor",z:gridz*sizeh}),C.camera({z:500+gridz*sizeh})}),griddown.onclick=(()=>{gridz&&gridz--,C.move({n:"grid",z:gridz*sizeh}),C.move({n:"cursor",z:gridz*sizeh}),C.camera({z:500+gridz*sizeh})}),gridrl.onclick=(()=>{0==gridrz&&(gridrz=360),gridrz-=90,gridrzreal-=90,C.camera({rz:gridrzreal})}),gridrr.onclick=(()=>{360==gridrz&&(gridrz=0),gridrz+=90,gridrzreal+=90,C.camera({rz:gridrzreal})}),blockrl.onclick=(()=>{0==cursorrz&&(cursorrz=360),cursorrz-=90,cursorrzreal-=90,C.move({n:"cursor",rz:cursorrzreal})}),blockrr.onclick=(()=>{360==cursorrz&&(cursorrz=0),cursorrz+=90,cursorrzreal+=90,C.move({n:"cursor",rz:cursorrzreal})}),setInterval(()=>{if(1==mode&&editor(),2==mode){for(times=0;times<5;times++){delog(),log("oob",oob),u?(carspeed+=.002)>(oob?.2:.4)&&(carspeed=oob?.2:.4):d?(carspeed-=.0015)<(oob?-.15:-.3)&&(carspeed=oob?-.15:-.3):carspeed*=.99,l&&u||r&&d?carrz-=.7:(r&&u||l&&d)&&(carrz+=.7),carx+=carspeed*Math.sin(toRadians(carrz)),cary-=carspeed*Math.cos(toRadians(carrz));var e=[carx+2*Math.sin(toRadians(carrz)),cary-2*Math.cos(toRadians(carrz)),0],i=[carx+-2*Math.sin(toRadians(carrz)),cary- -2*Math.cos(toRadians(carrz)),0];fcell=[~~(e[0]/size),~~(e[1]/size),0],bcell=[~~(i[0]/size),~~(i[1]/size),0],carspeed>=0?testcollision(e,fcell,fcellinfo):testcollision(i,bcell,bcellinfo),frontcell=fcell,backcell=bcell}collision&&(carspeed=speedduringcollision>=0?-.05:.05,(collision-=.1)<=0&&(collision=0)),C.camera({x:carx,y:cary,rz:-carrz}),C.move({n:"car",x:carx,y:cary,rz:carrz+90})}S=_=U=L=D=R=0},33)</script>
<script>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:calibri;cursor:pointer;user-select:none;-moz-user-select:none;}
#viewport{width:100vw;height:100vh;background:#fff;overflow:hidden;position:relative;perspective:500px}
#viewport *,.part *{transform-style:preserve-3d;box-sizing:border-box}
#camera{width:0;height:0;position:absolute;top:50%;left:50%}
.circle{border-radius:50%}
#deb{position:fixed;top:0;left:0;z-index:2;top:-999px;font-size:10px}
.plane{text-align:center;font-size:40px;}
.block0.z0{border:1px solid #ddd}
.barrierleftright{border-left:5px solid #000;border-right:5px solid #000}
.barriertopbottom{border-top:5px solid #000;border-bottom:5px solid #000}
#grid { background: linear-gradient(#888 2px, transparent 2px), linear-gradient(90deg, #888 2px, transparent 2px),#def8; background-size: 100px 100px; }
#menu { position: fixed; left: 0; top: 0; text-align:center; width: 145px; background: #fff; padding: 5px; border: 2px solid}
#menu div { width: 60px; display: inline-block; height: 30px; border: 2px solid #555; background:#eee; font-size: 20px; margin: 2px 0;}
#parts { position: fixed; bottom: 0; text-align:center; width: 100%; }
.part { width: 60px; height: 80px; border: 2px solid #555; background:#ddd; display: inline-block; vertical-align: top; perspective: 500px;}
.part.selected { background: #fff }
.visual { height: 30px; margin: 25px 30px 0; }
.editor #scene{ transition:.2s linear }
p{text-align:left;background:#eee; margin: 0 2px; padding: 5px}
#cursor { transition:.1s linear }
.acc { background:
linear-gradient(115deg, transparent 75%, #fd3 75%),
linear-gradient(-115deg, #d90 75%, #fd3 75%) 0 0,#d90;
background-size: 22px 24px; border-left: 5px solid; border-right: 5px solid;}