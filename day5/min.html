<body id=b>

<script>C={unit:"in",camX:0,camY:0,camZ:0,camRX:0,camRY:0,camRZ:0,plane_count:0,cube_count:0,options:{},$:r=>document.getElementById(r),init:r=>{r.css||(r.css=""),r.html||(r.html=""),r.g||(r.g="scene"),r.o||(r.o="center"),"bottom"==r.o&&(r.y-=r.h/2),r.w||(r.w=0),r.h||(r.h=0),r.x||(r.x=0),r.y||(r.y=0),r.z||(r.z=0),r.rx||(r.rx=0),r.ry||(r.ry=0),r.rz||(r.rz=0),r.sx||(r.sx=1),r.sy||(r.sy=1),r.sz||(r.sz=1),C.options[r.n]=r},group:r=>{r.d||0===r.d||(r.d=r.h),C.init(r),C.$(r.g).innerHTML+=`<div id="${r.n}"class="group ${r.css}"style="position:absolute;width:${r.w}${C.unit};height:${r.d}${C.unit};transform:${C.tr(r)}">`},plane:r=>{r.n||(r.n=`plane${C.plane_count++}`),C.init(r),C.$(r.g).innerHTML+=`<div id="${r.n}"class="plane ${r.css}"style="position:absolute;width:${r.w}${C.unit};height:${r.h}${C.unit};background:${r.b};transform-origin:${r.o};transform:${C.tr(r)}">${r.html}`,C.camera()},cube:r=>{r.n||(r.n=`cube${C.cube_count++}`),C.init(r),C.group(r),C.plane({g:r.n,x:r.w/2,y:r.d/2,w:r.w,h:r.d,b:r.b,css:"bottom"}),C.plane({g:r.n,y:r.d/2,w:r.d,h:r.h,b:r.b,rx:-90,ry:-90,o:"bottom",css:"left"}),C.plane({g:r.n,x:r.w,y:r.d/2,w:r.d,h:r.h,b:r.b3,rx:-90,ry:-90,o:"bottom",css:"right"}),C.plane({g:r.n,x:r.w/2,y:0,w:r.w,h:r.h,b:r.b2,rx:-90,o:"bottom",css:"back"}),C.plane({g:r.n,x:r.w/2,y:r.d,w:r.w,h:r.h,b:r.b2,rx:-90,o:"bottom",css:"front"}),C.plane({g:r.n,x:r.w/2,y:r.d/2,z:r.h,w:r.w,h:r.d,b:r.b,css:"top"})},camera:r=>{r&&(r.x||0===r.x)&&(C.camX=r.x),r&&(r.y||0===r.y)&&(C.camY=r.y),r&&(r.z||0===r.z)&&(C.camZ=r.z),r&&(r.rx||0===r.rx)&&(C.camRX=r.rx),r&&(r.ry||0===r.ry)&&(C.camRY=r.ry),r&&(r.rz||0===r.rz)&&(C.camRZ=r.rz),C.camX+=(Math.random()-.5)/1e3,scene.style.transformOrigin=`${C.camX}${C.unit} ${C.camY}${C.unit}`,scene.style.transform=`translateX(${-C.camX}${C.unit})translateY(${-C.camY}${C.unit})translateZ(${-C.camZ}${C.unit})rotateX(${C.camRX}deg)rotateY(${C.camRY}deg)rotateZ(${C.camRZ}deg)`},move:r=>{if(r.n){var i=C.$(r.n),a=C.options[r.n];(r.x||0===r.x)&&(a.x=r.x),(r.y||0===r.y)&&(a.y=r.y),(r.z||0===r.z)&&(a.z=r.z),(r.rx||0===r.rx)&&(a.rx=r.rx),(r.ry||0===r.ry)&&(a.ry=r.ry),(r.rz||0===r.rz)&&(a.rz=r.rz),C.options[r.n]=a,i.style.transform=C.tr(a)}},tr:r=>`${"top left"==r.o?"":"translateX(-50%)translateY(-50%)"}translateX(${r.x}${C.unit})translateY(${r.y}${C.unit})translateZ(${r.z}${C.unit})rotateX(${r.rx}deg)rotateY(${r.ry}deg)rotateZ(${r.rz}deg)`};var r=210,a=330,e=0,t=0,n=0,o=[],s=[],l=r=>r*(Math.PI/180),c=r=>{var[i,a,e]=r;if(0==e){var t=o[i][a][e];t.barriers={u:0,r:0,d:0,l:0},t.u+t.r+t.d+t.l>0&&(t.u||t.d?t.l||t.r?t.u&&t.l&&!t.r&&!t.d?(t.barriers.r=1,t.barriers.d=1):t.u&&!t.l&&t.r&&!t.d?(t.barriers.l=1,t.barriers.d=1):!t.u&&t.l&&!t.r&&t.d&&(t.barriers.r=1,t.barriers.u=1):(t.barriers.l=1,t.barriers.r=1):(t.barriers.u=1,t.barriers.d=1),!t.u&&!t.l&&t.r&&t.d?(t.barriers.u=1,t.barriers.l=1):t.u+t.r+t.d+t.l==3&&(t.u||(t.barriers.u=1),t.r||(t.barriers.r=1),t.d||(t.barriers.d=1),t.l||(t.barriers.l=1))),t.barriers.u&&C.plane({w:19+t.r+t.l,h:1,x:20*i+10+.5*t.r-.5*t.l,y:20*a+.5,z:20*e,b:"#555",rx:-90,o:"bottom"}),t.barriers.d&&C.plane({w:19+t.r+t.l,h:1,x:20*i+10+.5*t.r-.5*t.l,y:20*a+19.5,z:20*e,b:"#555",rx:-90,o:"bottom"}),t.barriers.l&&C.plane({w:19+t.d+t.u,h:1,x:20*i+.5,y:20*a+10+.5*t.d-.5*t.u,z:20*e,b:"#555",rx:-90,ry:90,o:"bottom"}),t.barriers.r&&C.plane({w:19+t.d+t.u,h:1,x:20*i+19.5,y:20*a+10+.5*t.d-.5*t.u,z:20*e,b:"#555",rx:-90,ry:90,o:"bottom"})}};(()=>{for(b.innerHTML="<textarea id=deb rows=6 cols=99></textarea><div id=viewport><div id=camera><div id=scene>",i=0;i<20;i++)for(o[i]=[],j=0;j<20;j++)o[i][j]=[];for(i of(C.camera({x:25,y:25,z:200,rx:40}),C.group({n:"car",w:0,h:0,rz:90}),C.cube({g:"car",b:"#a33",b2:"#922",b3:"#c44",w:4,d:2,h:.75,z:.4}),C.cube({g:"car",b:"#a33",b2:"#922",b3:"#c44",w:2,d:2,h:.55,z:1.15}),C.plane({g:"car",b:"#555",w:.8,h:.8,rx:90,x:1,y:1.1,z:.58,css:"circle"}),C.plane({g:"car",b:"#555",w:.8,h:.8,rx:90,x:1,y:-1.1,z:.58,css:"circle"}),C.plane({g:"car",b:"#555",w:.8,h:.8,rx:90,x:-1,y:1.1,z:.58,css:"circle"}),C.plane({g:"car",b:"#555",w:.8,h:.8,rx:90,x:-1,y:-1.1,z:.58,css:"circle"}),C.plane({g:"car",b:"#555",w:.3,h:.78,rx:90,ry:90,x:1,y:.95,z:.58}),C.plane({g:"car",b:"#555",w:.3,h:.78,rx:90,ry:90,x:1,y:-.95,z:.58}),C.plane({g:"car",b:"#555",w:.3,h:.78,rx:90,ry:90,x:-1,y:.95,z:.58}),C.plane({g:"car",b:"#555",w:.3,h:.78,rx:90,ry:90,x:-1,y:-.95,z:.58}),roads=[[10,16,0],[10,15,0],[10,14,0],[10,13,0],[9,13,0],[8,13,0],[8,12,0],[7,12,0],[7,11,0],[6,11,0],[6,10,0],[7,10,0],[8,10,0],[9,10,0],[10,10,0],[11,10,0],[11,9,0],[11,11,0],[12,10,0],[14,10,0],[15,10,0],[16,10,0],[16,11,0],[15,11,0],[15,12,0],[15,13,0],[15,14,0],[14,14,0],[13,14,0],[12,14,0],[11,14,0]],roads))o[i[0]][i[1]][i[2]]={type:0,u:0,r:0,d:0,l:0,barriers:{u:0,r:0,d:0,l:0}},C.plane({x:20*i[0],y:20*i[1],z:.1,w:20,h:20,b:"#ddd",o:"top left"}),C.plane({n:`road-${i[0]}-${i[1]}-${i[2]}`,x:20*i[0]+.5,y:20*i[1]+.5,z:.2,w:19,h:19,b:"#d90",o:"top left"});for(s=[[[11,10,0],[11,11,0]],[[11,10,0],[12,10,0]],[[15,10,0],[15,11,0]],[[11,14,0],[10,14,0]]],i=1;i<roads.length-1;i++)s.push([roads[i],roads[i+1]]);(()=>{for(i of s)i[0][0]==i[1][0]&&i[0][2]==i[1][2]&&i[0][1]==i[1][1]-1&&(C.plane({w:19,h:1,x:20*i[0][0]+.5,y:20*i[0][1]+19.5,z:.2,b:"#d90",o:"top left"}),o[i[0][0]][i[0][1]][i[0][2]].d=1,o[i[1][0]][i[1][1]][i[1][2]].u=1),i[0][0]==i[1][0]&&i[0][2]==i[1][2]&&i[0][1]==i[1][1]+1&&(C.plane({w:19,h:1,x:20*i[1][0]+.5,y:20*i[1][1]+19.5,z:.2,b:"#d90",o:"top left"}),o[i[0][0]][i[0][1]][i[0][2]].u=1,o[i[1][0]][i[1][1]][i[1][2]].d=1),i[0][0]==i[1][0]-1&&i[0][2]==i[1][2]&&i[0][1]==i[1][1]&&(C.plane({w:1,h:19,x:20*i[0][0]+19.5,y:20*i[1][1]+.5,z:.2,b:"#d90",o:"top left"}),o[i[0][0]][i[0][1]][i[0][2]].r=1,o[i[1][0]][i[1][1]][i[1][2]].l=1),i[0][0]==i[1][0]+1&&i[0][2]==i[1][2]&&i[0][1]==i[1][1]&&(C.plane({w:1,h:19,x:20*i[1][0]+19.5,y:20*i[1][1]+.5,z:.2,b:"#d90",o:"top left"}),o[i[0][0]][i[0][1]][i[0][2]].l=1,o[i[1][0]][i[1][1]][i[1][2]].r=1);for(i of s)c(i[0]),c(i[1])})()})();onkeydown=onkeyup=(r=>top["lld*rlurdu"[r.which%32%17]]=r.type[5]),setInterval(()=>{for(var i=0;i<5;i++){r+=(t*=.99)*Math.sin(l(e)),a-=t*Math.cos(l(e));var s,b,c=[r+2*Math.sin(l(e)),a-2*Math.cos(l(e))],y=[r+-2*Math.sin(l(e)),a- -2*Math.cos(l(e))],u=[~~(c[0]/20),~~(c[1]/20),0],h=[~~(y[0]/20),~~(y[1]/20),0];d(),x("oob",n,"front cell",JSON.stringify(u));try{s=o[u[0]][u[1]][u[2]]}catch(r){}try{b=o[h[0]][h[1]][h[2]]}catch(r){}n=0,s&&t>0?(x("front cell",JSON.stringify(s)),c[0]%20<1.5&&0==s.l&&(s.barriers.l?(x("barrier"),t=-.01):(x("snow"),n=1)),c[1]%20<1.5&&0==s.u&&(s.barriers.u?(x("barrieru"),t=-.01):(x("snow"),n=1)),c[0]%20>18.5&&0==s.r&&(s.barriers.r?(x("barrier"),t=-.01):(x("snow"),n=1)),c[1]%20>18.5&&0==s.d&&(s.barriers.d?(x("barrierd"),t=-.01):(x("snow"),n=1))):b&&t<0?(x("backcell",JSON.stringify(b)),y[0]%20<1.5&&0==b.l&&(b.barriers.l?(x("barrier"),t=.01):(x("snow"),n=1)),y[1]%20<1.5&&0==b.u&&(b.barriers.u?(x("barrier"),t=.01):(x("snow"),n=1)),y[0]%20>18.5&&0==b.r&&(b.barriers.r?(x("barrier"),t=.01):(x("snow"),n=1)),y[1]%20>18.5&&0==b.d&&(b.barriers.d?(x("barrier"),t=.01):(x("snow"),n=1))):(x("snow"),n=1),u,h}C.camera({x:r,y:a,rz:-e}),C.move({n:"car",x:r,y:a,rz:e+90})},33),setTimeout(()=>{rx=75,z=20,scene.style.transition="1s linear",C.camera({rx:rx,z:z})},500),setTimeout(()=>{C.camera({rx:rx,z:z})},1e3),setTimeout(()=>{scene.style.transition=".15s linear"},5e3);var d=()=>deb.innerHTML="",x=(...r)=>deb.innerHTML+=r+"\n";C.plane({x:210,y:335,z:10,w:19,h:5,rx:-90,b:"#abf",o:"center",html:"start"}),C.plane({x:200,y:335.1,z:7.5,w:1,h:10,rx:-90,b:"#000",o:"center"}),C.plane({x:219.5,y:335.1,z:7.5,w:1,h:10,rx:-90,b:"#000",o:"center"})
</script>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:calibri}
#viewport{width:100vw;height:100vh;background:#fff;overflow:hidden;position:relative;perspective:8in}
#viewport *{transform-style:preserve-3d;box-sizing:border-box}
#camera{width:0;height:0;position:absolute;top:50%;left:50%}
x#scene{transition:1s linear}
.group{transition:.1s linear}
.circle{border-radius:50%}
#deb{position:fixed;top:0;left:0;z-index:2;top:-999px;}
.plane{text-align:center;font-size:4in;}